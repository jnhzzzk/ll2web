<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Analysis - Line Loss Diagnostic Analysis Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#309C9F',
                        'primary-light': '#e6f1f1',
                        'primary-dark': '#256e70',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- Top Navigation Bar -->
    <nav class="bg-white border-b border-gray-200 fixed w-full z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center relative">
                        <span id="main-menu-button" class="text-primary text-xl font-bold cursor-pointer flex items-center">
                            Line Loss Diagnostic Analysis Application
                            <svg class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </span>
                        <div id="main-menu-dropdown" class="absolute left-0 top-full mt-1 w-48 bg-white rounded-md shadow-lg py-1 z-10 hidden">
                            <a href="/en" class="block px-4 py-2 text-sm text-gray-700 hover:bg-primary-light hover:text-primary">
                                Overview Statistics
                            </a>
                            <a href="/en/filter" class="block px-4 py-2 text-sm text-gray-700 hover:bg-primary-light hover:text-primary">
                                Filter Configuration
                            </a>
                            <a href="/en/diagnostic" class="block px-4 py-2 text-sm text-gray-700 bg-primary-light text-primary">
                                Diagnostic Analysis
                            </a>
                            <a href="/en/governance" class="block px-4 py-2 text-sm text-gray-700 hover:bg-primary-light hover:text-primary">
                                Governance Suggestions
                            </a>
                        </div>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="text-sm text-gray-600 mr-2">Engineer Wang</span>
                    <a href="/cn/diagnostic" class="px-3 py-1 rounded-md text-sm font-medium text-white bg-primary hover:bg-primary-dark mr-3">中文</a>
                    <img class="h-8 w-8 rounded-full" src="https://api.dicebear.com/7.x/avataaars/svg?seed=John" alt="User Avatar">
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="pt-16 pb-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Page Title and Area Selection -->
            <div class="mt-6 mb-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Diagnostic Analysis</h1>
                <div class="flex items-center space-x-3">
                    <div class="relative group">
                        <div class="w-64 h-10 rounded-md bg-transparent group-hover:bg-gray-50 flex items-center justify-center transition-colors duration-200 cursor-pointer"></div>
                        <div class="absolute top-0 left-0 w-64 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <select id="districtSelect" class="block w-full bg-white border border-gray-300 rounded-md py-2 pl-3 pr-10 text-sm leading-5 focus:outline-none focus:ring-primary focus:border-primary">
                                <option value="long-high" selected>Hexi Substation 1324 Area (+6.44%) - Long-term High Loss</option>
                                <option value="sudden-high">Chengnan 532 Area (+5.55%) - Sudden High Loss [Generated]</option>
                                <option value="long-negative">Donghu 785 Area (-4.24%) - Long-term Negative Loss [Generated]</option>
                                <option value="small-negative">Beijiao 198 Area (-0.85%) - Slight Negative Loss</option>
                                <option value="sudden-negative">Development Zone 672 Area (-3.76%) - Sudden Negative Loss</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="relative group">
                        <div class="w-32 h-8 rounded-md bg-transparent group-hover:bg-primary-light flex items-center justify-center transition-colors duration-200 cursor-pointer"></div>
                        <button id="governanceButton" class="absolute top-0 left-0 opacity-0 group-hover:opacity-100 bg-primary hover:bg-primary-dark text-white py-2 px-4 rounded-md text-sm leading-4 transition-all duration-200 whitespace-nowrap">
                            Generate Governance Suggestions
                        </button>
                    </div>
                </div>
            </div>

            <!-- Area Basic Information Card -->
            <div class="bg-white rounded-lg shadow-sm mb-6 p-5">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                    <div class="col-span-3">
                        <h2 class="text-lg font-medium text-gray-900 mb-3">Area Basic Information</h2>
                        <div class="grid grid-cols-2 gap-x-6 gap-y-2">
                            <div>
                                <p class="text-sm text-gray-500">Area Name</p>
                                <p class="text-sm font-medium">Hexi Substation 1324 Area</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Area Code</p>
                                <p class="text-sm font-medium">TQ-HX1324</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Transformer Capacity</p>
                                <p class="text-sm font-medium">400 kVA</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Number of Users</p>
                                <p class="text-sm font-medium">87 households</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Load Type</p>
                                <p class="text-sm font-medium">Residential + Commercial Mixed</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Region</p>
                                <p class="text-sm font-medium">Hexi Area</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">CT Ratio</p>
                                <p class="text-sm font-medium">300/5 A</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">PT Ratio</p>
                                <p class="text-sm font-medium">10000/100 V</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Total Ratio</p>
                                <p class="text-sm font-medium">600</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Wiring Method</p>
                                <p class="text-sm font-medium">Three-phase Four-wire</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Renewable Energy</p>
                                <p class="text-sm font-medium">None</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Communication Method</p>
                                <p class="text-sm font-medium">4G</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <h2 class="text-lg font-medium text-gray-900 mb-3">Line Loss Abnormality Overview</h2>
                        <div class="grid grid-cols-1 gap-y-2">
                            <div>
                                <p class="text-sm text-gray-500">Actual Line Loss Rate</p>
                                <p class="text-lg font-bold text-red-500">12.76%</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Theoretical Line Loss Rate</p>
                                <p class="text-lg font-bold text-primary">6.32%</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Difference</p>
                                <p class="text-lg font-bold text-red-500">+6.44%</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Abnormal Line Loss Days</p>
                                <p class="text-sm font-medium">28 days <span class="text-xs text-gray-500">(last 30 days)</span></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Abnormal Status</p>
                                <p class="text-sm font-medium text-red-500">Long-term High Loss</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Governance Suggestions</p>
                                <p class="text-sm font-medium" id="governanceStatus">Not Generated</p>
                            </div>
                            <div class="mt-2">
                                <p class="text-xs text-gray-500">Data Source: Filter A - Line Loss Statistics Period: 2024-04-10 - 2024-05-10</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Line Loss Fluctuation Traceability Chart -->
                <div class="col-span-1 lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-sm mb-6">
                        <div class="px-5 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-medium text-gray-900">Line Loss Fluctuation Traceability Chart</h2>
                        </div>
                        <div class="p-5">
                            <div class="h-72">
                                <canvas id="lossAnalysisChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Diagnostic Classification Panel -->
                <div class="col-span-1">
                    <div class="bg-white rounded-lg shadow-sm mb-6">
                        <div class="px-5 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-medium text-gray-900">Intelligent Diagnostic Tags</h2>
                        </div>
                        <div class="px-5 pt-4 pb-2 border-b border-gray-100 flex items-center">
                            <input type="checkbox" id="select-all-tags" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="select-all-tags" class="ml-2 text-sm text-gray-700 font-medium cursor-pointer">Select All</label>
                        </div>
                        <div class="p-5">
                            <div class="flex flex-col space-y-3">
                                <div class="flex items-center p-3 bg-red-50 border border-red-100 rounded-lg">
                                    <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-red-100 rounded-full">
                                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-red-800">CT Ratio Error</h3>
                                        <p class="text-xs text-red-700 mt-1">Match Probability: 92%</p>
                                    </div>
                                </div>
                                <div class="flex items-center p-3 bg-orange-50 border border-orange-100 rounded-lg">
                                    <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-orange-100 rounded-full">
                                        <i class="fas fa-file-alt text-orange-500"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-orange-800">Abnormal Household-Transformer Relationship in Archives</h3>
                                        <p class="text-xs text-orange-700 mt-1">Match Probability: 68%</p>
                                    </div>
                                </div>
                                <div class="flex items-center p-3 bg-yellow-50 border border-yellow-100 rounded-lg">
                                    <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-yellow-100 rounded-full">
                                        <i class="fas fa-bolt text-yellow-500"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-yellow-800">Suspected Low-Voltage Electricity Theft</h3>
                                        <p class="text-xs text-yellow-700 mt-1">Match Probability: 45%</p>
                                    </div>
                                </div>
                                <div class="flex items-center p-3 bg-blue-50 border border-blue-100 rounded-lg">
                                    <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-blue-100 rounded-full">
                                        <i class="fas fa-sync-alt text-blue-500"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-blue-800">Three-Phase Imbalance</h3>
                                        <p class="text-xs text-blue-700 mt-1">Match Probability: 38%</p>
                                    </div>
                                </div>
                                
                                <!-- Add extra vertical space to align with right-side card -->
                                <div class="py-10"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Action Area -->
            <div class="flex justify-between">
                <div class="flex space-x-2">
                    <a href="/en/filter" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-md text-sm transition-colors duration-200">
                        <i class="fas fa-arrow-left mr-1"></i> Back to Filtering
                    </a>
                    <div class="relative group">
                        <div class="w-10 h-8 rounded-md bg-transparent group-hover:bg-purple-50 flex items-center justify-center transition-colors duration-200 cursor-pointer"></div>
                        <a href="/demo/new/diagnostic-tags-new.html" class="absolute top-0 left-0 opacity-0 group-hover:opacity-100 bg-purple-100 hover:bg-purple-200 text-purple-700 py-2 px-4 rounded-md text-sm transition-all duration-200 whitespace-nowrap">
                            <i class="fas fa-tags mr-1"></i> View Diagnostic Tags Demo
                        </a>
                    </div>
                </div>
                <a href="/en/governance" class="bg-primary hover:bg-primary-dark text-white py-2 px-4 rounded-md text-sm transition-colors duration-200">
                    Generate Governance Suggestions <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Multi-dimensional Comparison Analysis Modal -->
    <div id="analysisModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-6xl max-h-[90vh] overflow-auto">
            <div class="px-5 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-medium text-gray-900">Multi-dimensional Comparison Analysis</h2>
                <div class="flex space-x-2 items-center">
                    <button id="compareNormal" class="bg-primary-light text-primary px-3 py-1 rounded-md text-sm">Similar Normal Areas</button>
                    <button id="compareHistory" class="text-gray-500 hover:bg-gray-100 px-3 py-1 rounded-md text-sm">Historical Same Period</button>
                    <button id="closeAnalysisModal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Comparison with Similar Normal Areas -->
            <div id="normalComparisonView" class="p-5 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Comparison Metrics Card -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Load Characteristics Comparison</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-500">Average Load Factor</p>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-primary rounded-full mr-1"></div>
                                <span class="text-sm font-medium">42.7%</span>
                                <span class="text-xs text-gray-500 ml-1">(This Area)</span>
                            </div>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-gray-400 rounded-full mr-1"></div>
                                <span class="text-sm font-medium">45.2%</span>
                                <span class="text-xs text-gray-500 ml-1">(Comparison Group)</span>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Max/Avg Load Ratio</p>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-primary rounded-full mr-1"></div>
                                <span class="text-sm font-medium">1.68</span>
                                <span class="text-xs text-gray-500 ml-1">(This Area)</span>
                            </div>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-gray-400 rounded-full mr-1"></div>
                                <span class="text-sm font-medium">1.72</span>
                                <span class="text-xs text-gray-500 ml-1">(Comparison Group)</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 h-40">
                        <canvas id="loadCurveChart"></canvas>
                    </div>
                </div>
                
                <!-- Three-Phase Imbalance -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Three-Phase Imbalance Analysis</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-500">Three-Phase Imbalance Degree</p>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-yellow-500 rounded-full mr-1"></div>
                                <span class="text-sm font-medium">17.3%</span>
                                <span class="text-xs text-gray-500 ml-1">(This Area)</span>
                            </div>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-gray-400 rounded-full mr-1"></div>
                                <span class="text-sm font-medium">12.1%</span>
                                <span class="text-xs text-gray-500 ml-1">(Comparison Group)</span>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Power Factor</p>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-primary rounded-full mr-1"></div>
                                <span class="text-sm font-medium">0.92</span>
                                <span class="text-xs text-gray-500 ml-1">(This Area)</span>
                            </div>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-gray-400 rounded-full mr-1"></div>
                                <span class="text-sm font-medium">0.94</span>
                                <span class="text-xs text-gray-500 ml-1">(Comparison Group)</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 h-40">
                        <canvas id="phaseBalanceChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Historical Comparison (New) -->
            <div id="historyComparisonView" class="p-5 grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                <!-- Seasonal Change in Line Loss Rate -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Seasonal Change in Line Loss Rate</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-500">Avg Loss Rate This Quarter</p>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-red-500 rounded-full mr-1"></div>
                                <span class="text-sm font-medium">12.76%</span>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Avg Loss Rate Same Period Last Year</p>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-gray-400 rounded-full mr-1"></div>
                                <span class="text-sm font-medium">6.78%</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 h-40">
                        <canvas id="seasonalLossChart"></canvas>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        <p>Abnormality Description: Compared to the same period last year, the line loss rate increased by <span class="text-red-500 font-medium">5.98%</span>, significantly exceeding the seasonal fluctuation range.</p>
                    </div>
                </div>
                
                <!-- Historical Comparison of Power Consumption Load -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Historical Comparison of Power Consumption Load</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-500">Avg Consumption This Period</p>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-primary rounded-full mr-1"></div>
                                <span class="text-sm font-medium">3,246 kWh</span>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Consumption Same Period Last Year</p>
                            <div class="flex items-center mt-1">
                                <div class="w-3 h-3 bg-gray-400 rounded-full mr-1"></div>
                                <span class="text-sm font-medium">3,127 kWh</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 h-40">
                        <canvas id="historicalLoadChart"></canvas>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        <p>Conclusion: Power consumption load increased by <span class="text-primary font-medium">3.8%</span> compared to the same period last year, which is within the normal range and does not explain the significant increase in line loss rate.</p>
                    </div>
                </div>
                
                <!-- Key Node Analysis -->
                <div class="col-span-1 md:col-span-2 bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Key Node Analysis</h3>
                    <div class="relative">
                        <div class="absolute h-full w-1 bg-gray-200 left-2.5 top-0"></div>
                        <div class="space-y-4 relative">
                            <div class="flex items-start">
                                <div class="h-5 w-5 rounded-full bg-red-500 flex-shrink-0 z-10"></div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-800">April 6, 2023</p>
                                    <p class="text-xs text-gray-600">Line loss rate suddenly jumped from 6.8% to 12.5%, automatically marked as an abnormal point by the system</p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="h-5 w-5 rounded-full bg-gray-400 flex-shrink-0 z-10"></div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-800">March 15, 2023</p>
                                    <p class="text-xs text-gray-600">Previous governance completed, line loss rate returned to normal (6.8%)</p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="h-5 w-5 rounded-full bg-gray-400 flex-shrink-0 z-10"></div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-800">February 18, 2023</p>
                                    <p class="text-xs text-gray-600">Suspected low-voltage electricity theft detected, governance process initiated</p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="h-5 w-5 rounded-full bg-gray-400 flex-shrink-0 z-10"></div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-800">Same Period in 2022</p>
                                    <p class="text-xs text-gray-600">Line loss rate stable between 6.5%~7.0%, within the normal range</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Interactive Troubleshooting Tool -->
            <div class="p-5">
                <div class="bg-gray-50 rounded-lg p-4 col-span-1 md:col-span-2">
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Interactive Troubleshooting Tool</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="col-span-1">
                            <p class="text-xs text-gray-500 mb-1">Adjust CT Ratio</p>
                            <div class="flex rounded-md shadow-sm">
                                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">Current</span>
                                <input type="text" value="300/5" class="flex-1 min-w-0 block w-full px-3 py-1.5 rounded-none border border-gray-300 focus:ring-primary focus:border-primary text-sm">
                                <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">A</span>
                            </div>
                            <div class="mt-2">
                                <select class="block w-full pl-3 pr-10 py-1.5 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md">
                                    <option>Simulate correction to 150/5 A</option>
                                    <option>Simulate correction to 200/5 A</option>
                                    <option selected>Simulate correction to 250/5 A</option>
                                    <option>Simulate correction to 400/5 A</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-span-2">
                            <p class="text-xs text-gray-500 mb-1">Predicted Line Loss After Correction</p>
                            <div class="flex h-20 items-center">
                                <div class="flex-1 flex items-center space-x-2">
                                    <div class="h-16 w-16 rounded-full bg-primary flex items-center justify-center text-white text-xl font-bold">
                                        6.51%
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500">Predicted Loss Rate After Correction</p>
                                        <p class="text-xs text-green-500 font-medium mt-1">Deviation from Theoretical Loss: +0.19%</p>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="relative w-full h-4 bg-gray-200 rounded">
                                        <div class="absolute h-4 bg-primary rounded" style="width: 21.7%;"></div>
                                    </div>
                                    <div class="flex justify-between mt-1 text-xs text-gray-500">
                                        <span>0%</span>
                                        <span>6.51%</span>
                                        <span>30%</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Line loss rate reduced by <span class="text-green-500 font-medium">6.25%</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Line Loss Fluctuation Traceability Chart
        const lossCtx = document.getElementById('lossAnalysisChart').getContext('2d');
        const lossAnalysisChart = new Chart(lossCtx, {
            type: 'line',
            data: {
                labels: ['3/15', '3/22', '3/29', '4/5', '4/12', '4/19', '4/26', '5/3'],
                datasets: [
                    {
                        label: 'Actual Loss Rate',
                        data: [6.8, 6.9, 6.7, 12.5, 12.8, 12.7, 12.9, 12.76],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Theoretical Loss Rate',
                        data: [6.5, 6.4, 6.3, 6.2, 6.4, 6.3, 6.35, 6.32],
                        borderColor: '#309C9F',
                        backgroundColor: 'rgba(48, 156, 159, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Loss Amount',
                        data: [245, 252, 238, 450, 462, 458, 465, 460],
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        borderColor: 'rgba(239, 68, 68, 0.8)',
                        borderWidth: 1,
                        yAxisID: 'y1',
                        type: 'bar'
                    },
                    {
                        label: 'Deviation Loss Amount',
                        data: [0, 0, 0, 205, 212, 208, 215, 210],
                        backgroundColor: 'rgba(48, 156, 159, 0.2)',
                        borderColor: 'rgba(48, 156, 159, 0.8)',
                        borderWidth: 1,
                        yAxisID: 'y1',
                        type: 'bar'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    annotation: {
                        annotations: {
                            point1: {
                                type: 'point',
                                xValue: 3,
                                yValue: 12.5,
                                backgroundColor: 'rgba(255, 99, 132, 0.25)',
                                borderWidth: 1,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                radius: 10
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: false,
                        min: 0,
                        max: 15,
                        title: {
                            display: true,
                            text: 'Loss Rate (%)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Loss Amount (kWh)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });

        // Load Curve Comparison Chart
        const loadCtx = document.getElementById('loadCurveChart').getContext('2d');
        const loadCurveChart = new Chart(loadCtx, {
            type: 'line',
            data: {
                labels: ['0:00', '4:00', '8:00', '12:00', '16:00', '20:00'],
                datasets: [
                    {
                        label: 'This Area',
                        data: [35, 25, 40, 60, 55, 68],
                        borderColor: '#309C9F',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.4
                    },
                    {
                        label: 'Comparison Group',
                        data: [38, 28, 45, 65, 60, 70],
                        borderColor: '#9ca3af',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        align: 'end',
                        labels: {
                            boxWidth: 10,
                            usePointStyle: true
                        }
                    },
                    title: {
                        display: true,
                        text: 'Daily Load Curve'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: false,
                            text: 'Load Percentage'
                        }
                    }
                }
            }
        });

        // Three-Phase Imbalance Chart
        const phaseCtx = document.getElementById('phaseBalanceChart').getContext('2d');
        const phaseBalanceChart = new Chart(phaseCtx, {
            type: 'bar',
            data: {
                labels: ['Phase A', 'Phase B', 'Phase C'],
                datasets: [
                    {
                        label: 'This Area',
                        data: [145, 98, 162],
                        backgroundColor: '#309C9F',
                    },
                    {
                        label: 'Comparison Group',
                        data: [125, 118, 142],
                        backgroundColor: '#9ca3af',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        align: 'end',
                        labels: {
                            boxWidth: 10,
                            usePointStyle: true
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Current (A)'
                        }
                    }
                }
            }
        });

        // Seasonal Line Loss Rate Change Chart
        const seasonalCtx = document.getElementById('seasonalLossChart').getContext('2d');
        const seasonalLossChart = new Chart(seasonalCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [
                    {
                        label: 'This Year',
                        data: [6.8, 6.7, 6.6, 12.7, 12.8, null, null, null, null, null, null, null],
                        borderColor: '#ef4444',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.3
                    },
                    {
                        label: 'Last Year',
                        data: [6.9, 6.7, 6.8, 6.8, 6.7, 6.5, 6.4, 6.6, 6.7, 6.9, 7.0, 6.8],
                        borderColor: '#9ca3af',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        align: 'end',
                        labels: {
                            boxWidth: 10,
                            usePointStyle: true
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 4,
                        max: 14,
                        title: {
                            display: true,
                            text: 'Line Loss Rate (%)'
                        }
                    }
                }
            }
        });

        // Historical Load Comparison Chart
        const histLoadCtx = document.getElementById('historicalLoadChart').getContext('2d');
        const historicalLoadChart = new Chart(histLoadCtx, {
            type: 'bar',
            data: {
                labels: ['First Quarter', 'Second Quarter', 'Third Quarter', 'Fourth Quarter'],
                datasets: [
                    {
                        label: 'This Year',
                        data: [3120, 3246, null, null],
                        backgroundColor: '#309C9F',
                    },
                    {
                        label: 'Last Year',
                        data: [3050, 3127, 3405, 3280],
                        backgroundColor: '#9ca3af',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        align: 'end',
                        labels: {
                            boxWidth: 10,
                            usePointStyle: true
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Electricity Consumption (kWh)'
                        }
                    }
                }
            }
        });

        // View switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const normalView = document.getElementById('normalComparisonView');
            const historyView = document.getElementById('historyComparisonView');
            const compareNormalBtn = document.getElementById('compareNormal');
            const compareHistoryBtn = document.getElementById('compareHistory');

            compareNormalBtn.addEventListener('click', () => {
                normalView.classList.remove('hidden');
                historyView.classList.add('hidden');
                compareNormalBtn.classList.add('bg-primary-light', 'text-primary');
                compareNormalBtn.classList.remove('text-gray-500', 'hover:bg-gray-100');
                compareHistoryBtn.classList.add('text-gray-500', 'hover:bg-gray-100');
                compareHistoryBtn.classList.remove('bg-primary-light', 'text-primary');
            });

            compareHistoryBtn.addEventListener('click', () => {
                normalView.classList.add('hidden');
                historyView.classList.remove('hidden');
                compareHistoryBtn.classList.add('bg-primary-light', 'text-primary');
                compareHistoryBtn.classList.remove('text-gray-500', 'hover:bg-gray-100');
                compareNormalBtn.classList.add('text-gray-500', 'hover:bg-gray-100');
                compareNormalBtn.classList.remove('bg-primary-light', 'text-primary');
            });
            
            // District switching functionality
            const districtSelect = document.getElementById('districtSelect');
            districtSelect.addEventListener('change', function() {
                updateDistrictInfo(this.value);
            });
            
            // Initialize district information
            updateDistrictInfo('long-high');
        });
          
        // District information update function
        function updateDistrictInfo(districtType) {
            // Basic information configuration
            const districtConfig = {
                'long-high': {
                    name: 'Hexi Substation 1324 Area',
                    code: 'TQ-HX1324',
                    capacity: '400 kVA',
                    users: '87 households',
                    loadType: 'Residential + Commercial Mixed',
                    area: 'Hexi Area',
                    ctRatio: '300/5 A',
                    ptRatio: '10000/100 V',
                    totalRatio: '600',
                    wireType: 'Three-phase Four-wire',
                    renewableEnergy: 'None',
                    commType: '4G',
                    actualLoss: '12.76%',
                    theoryLoss: '6.32%',
                    difference: '+6.44%',
                    abnormalDays: '28 days',
                    abnormalState: 'Long-term High Loss',
                    abnormalStateColor: 'text-red-500',
                    governanceStatus: 'Not Generated',
                    governanceStatusColor: 'text-gray-600'
                },
                'sudden-high': {
                    name: 'Chengnan 532 Area',
                    code: 'TQ-CN532',
                    capacity: '315 kVA',
                    users: '65 households',
                    loadType: 'Residential + Commercial Mixed',
                    area: 'Chengnan Area',
                    ctRatio: '250/5 A',
                    ptRatio: '10000/100 V',
                    totalRatio: '500',
                    wireType: 'Three-phase Four-wire',
                    renewableEnergy: 'Solar',
                    commType: '4G',
                    actualLoss: '11.95%',
                    theoryLoss: '6.40%',
                    difference: '+5.55%',
                    abnormalDays: '5 days',
                    abnormalState: 'Sudden High Loss',
                    abnormalStateColor: 'text-orange-500',
                    governanceStatus: 'Generated',
                    governanceStatusColor: 'text-green-600'
                },
                'long-negative': {
                    name: 'Donghu 785 Area',
                    code: 'TQ-DH785',
                    capacity: '500 kVA',
                    users: '95 households',
                    loadType: 'Residential + Industrial Mixed',
                    area: 'Donghu Area',
                    ctRatio: '400/5 A',
                    ptRatio: '10000/100 V',
                    totalRatio: '800',
                    wireType: 'Three-phase Four-wire',
                    renewableEnergy: 'Wind',
                    commType: 'Fiber',
                    actualLoss: '-4.24%',
                    theoryLoss: '6.8%',
                    difference: '-4.24%',
                    abnormalDays: '32 days',
                    abnormalState: 'Long-term Negative Loss',
                    abnormalStateColor: 'text-blue-500',
                    governanceStatus: 'Generated',
                    governanceStatusColor: 'text-green-600'
                },
                'small-negative': {
                    name: 'Beijiao 198 Area',
                    code: 'TQ-BJ198',
                    capacity: '200 kVA',
                    users: '42 households',
                    loadType: 'Residential',
                    area: 'Beijiao Area',
                    ctRatio: '150/5 A',
                    ptRatio: '10000/100 V',
                    totalRatio: '300',
                    wireType: 'Three-phase Four-wire',
                    renewableEnergy: 'None',
                    commType: '4G',
                    actualLoss: '-0.85%',
                    theoryLoss: '5.20%',
                    difference: '-6.05%',
                    abnormalDays: '25 days',
                    abnormalState: 'Slight Negative Loss',
                    abnormalStateColor: 'text-indigo-500',
                    governanceStatus: 'Not Generated',
                    governanceStatusColor: 'text-gray-600'
                },
                'sudden-negative': {
                    name: 'Development Zone 672 Area',
                    code: 'TQ-KF672',
                    capacity: '630 kVA',
                    users: '23 households',
                    loadType: 'Industrial',
                    area: 'Development Zone',
                    ctRatio: '500/5 A',
                    ptRatio: '10000/100 V',
                    totalRatio: '1000',
                    wireType: 'Three-phase Four-wire',
                    renewableEnergy: 'None',
                    commType: 'Fiber',
                    actualLoss: '-3.76%',
                    theoryLoss: '4.95%',
                    difference: '-8.71%',
                    abnormalDays: '4 days',
                    abnormalState: 'Sudden Negative Loss',
                    abnormalStateColor: 'text-purple-500',
                    governanceStatus: 'Not Generated',
                    governanceStatusColor: 'text-gray-600'
                }
            };
            
            // Get configuration
            const config = districtConfig[districtType];
            
            // Update basic information
            const infoLabels = document.querySelectorAll('.grid.grid-cols-2.gap-x-6.gap-y-2 > div > p:first-child');
            infoLabels.forEach(label => {
                const valueEl = label.nextElementSibling;
                if (!valueEl) return;
                
                switch(label.textContent.trim()) {
                    case 'Area Name': valueEl.textContent = config.name; break;
                    case 'Area Code': valueEl.textContent = config.code; break;
                    case 'Transformer Capacity': valueEl.textContent = config.capacity; break;
                    case 'Number of Users': valueEl.textContent = config.users; break;
                    case 'Load Type': valueEl.textContent = config.loadType; break;
                    case 'Region': valueEl.textContent = config.area; break;
                    case 'CT Ratio': valueEl.textContent = config.ctRatio; break;
                    case 'PT Ratio': valueEl.textContent = config.ptRatio; break;
                    case 'Total Ratio': valueEl.textContent = config.totalRatio; break;
                    case 'Wiring Method': valueEl.textContent = config.wireType; break;
                    case 'Renewable Energy': valueEl.textContent = config.renewableEnergy; break;
                    case 'Communication Method': valueEl.textContent = config.commType; break;
                }
            });
            
            // Update line loss overview
            const abnormalLabels = document.querySelectorAll('.col-span-2 .grid.grid-cols-1.gap-y-2 > div > p:first-child');
            abnormalLabels.forEach(label => {
                const valueEl = label.nextElementSibling;
                if (!valueEl) return;
                
                switch(label.textContent.trim()) {
                    case 'Actual Line Loss Rate': 
                        valueEl.textContent = config.actualLoss;
                        valueEl.className = 'text-lg font-bold ' + (parseFloat(config.actualLoss) > 0 ? 'text-red-500' : 'text-blue-500');
                        break;
                    case 'Theoretical Line Loss Rate': 
                        valueEl.textContent = config.theoryLoss;
                        break;
                    case 'Difference': 
                        valueEl.textContent = config.difference;
                        valueEl.className = 'text-lg font-bold ' + (parseFloat(config.difference) > 0 ? 'text-red-500' : 'text-blue-500');
                        break;
                    case 'Abnormal Line Loss Days': 
                        valueEl.innerHTML = config.abnormalDays + ' <span class="text-xs text-gray-500">(last 30 days)</span>';
                        break;
                    case 'Abnormal Status':
                        valueEl.textContent = config.abnormalState;
                        valueEl.className = 'text-sm font-medium ' + config.abnormalStateColor;
                        break;
                    case 'Governance Suggestions':
                        valueEl.textContent = config.governanceStatus;
                        valueEl.className = 'text-sm font-medium ' + config.governanceStatusColor;
                        document.getElementById('governanceStatus').textContent = config.governanceStatus; // Also update the standalone status element
                        break;
                }
            });
            
            // Update diagnostic tags
            updateDiagnosticTags(districtType);
            
            // Update charts
            updateCharts(districtType);
            
            // Update governance button
            updateGovernanceButton(districtType);
        }
          
        // Update governance button
        function updateGovernanceButton(districtType) {
            const button = document.getElementById('governanceButton');
            const hasGovernance = districtType === 'sudden-high' || districtType === 'long-negative';
            
            if (hasGovernance) {
                button.textContent = 'View Governance Suggestions';
                button.className = 'absolute top-0 left-0 opacity-0 group-hover:opacity-100 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md text-sm leading-4 transition-all duration-200 whitespace-nowrap';
            } else {
                button.textContent = 'Generate Governance Suggestions';
                button.className = 'absolute top-0 left-0 opacity-0 group-hover:opacity-100 bg-primary hover:bg-primary-dark text-white py-2 px-4 rounded-md text-sm leading-4 transition-all duration-200 whitespace-nowrap';
            }
        }
          
        // Diagnostic tags update function
        function updateDiagnosticTags(districtType) {
            // Clear current diagnostic tags
            const tagContainer = document.querySelector('.flex.flex-col.space-y-3');
            tagContainer.innerHTML = '';
            
            // Display corresponding diagnostic tags based on district type
            const diagnosticTags = {
                'long-high': [
                    {
                        title: 'CT Transformer Ratio Error',
                        probability: '92%',
                        icon: 'exclamation-triangle',
                        color: 'red',
                        details: [
                            'Event Code: E-269, E-270',
                            'Line Loss Stability: 0.85',
                            'Common Cause: Transformer replacement system parameter not updated'
                        ]
                    },
                    {
                        title: 'Archives Household-Transformer Relationship Anomaly',
                        probability: '68%',
                        icon: 'file-alt',
                        color: 'orange',
                        details: [
                            'Household-Transformer Consistency: 0.72',
                            'User Change Record: 3 times',
                            'Common Cause: System not updated after user migration'
                        ]
                    },
                    {
                        title: 'Suspected Low-Voltage Electricity Theft',
                        probability: '45%',
                        icon: 'bolt',
                        color: 'yellow',
                        details: [
                            'Nighttime Power Usage Pattern: Abnormal',
                            'Holiday Power Usage: Abnormal',
                            'Load Spike: 2 times'
                        ]
                    },
                    {
                        title: 'Three-Phase Imbalance',
                        probability: '38%',
                        icon: 'sync-alt',
                        color: 'blue',
                        details: [
                            'Imbalance Degree: 17.3%',
                            'Duration: 15 days',
                            'Event Code: E-279, E-280'
                        ]
                    }
                ],
                'sudden-high': [
                    {
                        title: 'Sudden Increase in Load',
                        probability: '87%',
                        icon: 'bolt',
                        color: 'red',
                        details: [
                            'Load Increase: 32.6%',
                            'Time Point of Change: April 28th',
                            'Common Cause: Seasonal power equipment activation'
                        ]
                    },
                    {
                        title: 'Low-Voltage Equipment Failure',
                        probability: '65%',
                        icon: 'exclamation-triangle',
                        color: 'orange',
                        details: [
                            'Equipment Temperature: Abnormal',
                            'Failure Alarm Count: 2 times',
                            'Common Cause: Equipment aging and damage'
                        ]
                    },
                    {
                        title: 'Short-Circuit Fault',
                        probability: '52%',
                        icon: 'tint',
                        color: 'yellow',
                        details: [
                            'Ground Current: Abnormal',
                            'Environmental Humidity: High',
                            'Insulation Resistance: Decreased'
                        ]
                    },
                    {
                        title: 'Problems Caused by Adverse Weather',
                        probability: '48%',
                        icon: 'cloud-rain',
                        color: 'blue',
                        details: [
                            'Weather Correlation: Heavy rain on April 27th',
                            'Equipment Condition: Possibly damp',
                            'Common Cause: Water infiltration into equipment'
                        ]
                    }
                ],
                'long-negative': [
                    {
                        title: 'Error in Line Connection',
                        probability: '94%',
                        icon: 'plug',
                        color: 'red',
                        details: [
                            'Connection Check: Abnormal',
                            'Line Loss Stability: 0.88',
                            'Common Cause: Wiring error during construction'
                        ]
                    },
                    {
                        title: 'Incorrect Connection of Power Meter',
                        probability: '78%',
                        icon: 'exchange-alt',
                        color: 'orange',
                        details: [
                            'Event Code: E-257, E-258',
                            'Solar Capacity: 15kW',
                            'Common Cause: Inconsistent setting of distributed power grid metering point'
                        ]
                    },
                    {
                        title: 'Inconsistency in Household-Transformer Relationship',
                        probability: '63%',
                        icon: 'file-alt',
                        color: 'yellow',
                        details: [
                            'Household-Meter Comparison: Inconsistent',
                            'Anomalous Record: 5 times',
                            'Common Cause: System migration data error'
                        ]
                    },
                    {
                        title: 'Error in Solar Power Generation Archive',
                        probability: '42%',
                        icon: 'solar-panel',
                        color: 'blue',
                        details: [
                            'Difference in Solar Capacity: +8kW',
                            'Power Generation Record: Abnormal',
                            'Common Cause: Inaccurate registration of solar capacity'
                        ]
                    }
                ],
                'small-negative': [
                    {
                        title: 'Deviation in Theoretical Model Calculation',
                        probability: '89%',
                        icon: 'calculator',
                        color: 'red',
                        details: [
                            'Load Factor: Below 15%',
                            'Sensitivity of Theoretical Model Parameters: High',
                            'Common Cause: Model not applicable at low load'
                        ]
                    },
                    {
                        title: 'Unreasonable Configuration of Current Transformer',
                        probability: '72%',
                        icon: 'cogs',
                        color: 'orange',
                        details: [
                            'Secondary Load Rate: 8.2%',
                            'Accuracy of Current Transformer: 0.5S',
                            'Common Cause: Current Transformer ratio selection too large'
                        ]
                    },
                    {
                        title: 'Deviation in Data Collection',
                        probability: '58%',
                        icon: 'database',
                        color: 'yellow',
                        details: [
                            'Data Quality Score: 83',
                            'Clock Synchronization Status: Mild Discrepancy',
                            'Common Cause: Data timestamp not synchronized'
                        ]
                    },
                    {
                        title: 'Clock Error of Power Meter',
                        probability: '45%',
                        icon: 'clock',
                        color: 'blue',
                        details: [
                            'Event Code: E-1538',
                            'Clock Drift: 2.3 minutes',
                            'Common Cause: Clock chip drift of power meter'
                        ]
                    }
                ],
                'sudden-negative': [
                    {
                        title: 'Fault in Power Meter Measurement',
                        probability: '91%',
                        icon: 'tachometer-alt',
                        color: 'red',
                        details: [
                            'Fault Code: E-258',
                            'Time Correlation: April 20th',
                            'Common Cause: Damaged internal components of power meter'
                        ]
                    },
                    {
                        title: 'Change in Ratio Not Synchronized',
                        probability: '79%',
                        icon: 'sync',
                        color: 'orange',
                        details: [
                            'Equipment Change Record: April 19th',
                            'Time Correlation: High',
                            'Common Cause: System archive not updated after replacing current transformer'
                        ]
                    },
                    {
                        title: 'Failure of Power Factor Compensation Equipment',
                        probability: '64%',
                        icon: 'bolt',
                        color: 'yellow',
                        details: [
                            'Change in Power Factor: 0.95→0.82',
                            'Time Correlation: High',
                            'Common Cause: Failure of power capacitor'
                        ]
                    },
                    {
                        title: 'Anomaly in Total Meter of Substation',
                        probability: '58%',
                        icon: 'exclamation-triangle',
                        color: 'blue',
                        details: [
                            'Change in Imbalance Degree: Increased by 15%',
                            'Event Code: E-299',
                            'Common Cause: Poor contact with one phase'
                        ]
                    }
                ]
            };
            
            // Add corresponding tags
            const tags = diagnosticTags[districtType];
            tags.forEach((tag, index) => {
                const tagWrapper = document.createElement('div');
                tagWrapper.className = `flex items-start p-3 bg-${tag.color}-50 border border-${tag.color}-100 rounded-lg`;
                tagWrapper.innerHTML = `
                    <input type="checkbox" id="tag-${index}" class="mt-1 mr-2 w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary diagnostic-tag-checkbox" checked>
                    <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-${tag.color}-100 rounded-full">
                        <i class="fas fa-${tag.icon} text-${tag.color}-500"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <label for="tag-${index}" class="text-sm font-medium text-${tag.color}-800 cursor-pointer block">${tag.title}</label>
                        <p class="text-xs text-${tag.color}-700 mt-1">Match Probability: ${tag.probability}</p>
                        <div class="mt-2 text-xs text-gray-500">
                            ${tag.details.map(detail => `<p>${detail}</p>`).join('')}
                        </div>
                    </div>
                `;
                tagContainer.appendChild(tagWrapper);
            });
            
            // Update historical diagnostic records
            updateHistoryRecords(districtType);
            
            // Update select all checkbox status
            setTimeout(updateSelectAllCheckbox, 0);
        }
          
        // Historical diagnostic records update function
        function updateHistoryRecords(districtType) {
            // Find historical records container
            const historyHeaderEl = document.querySelector('h3.text-sm.font-medium.text-gray-700.mb-2');
            if (!historyHeaderEl) return;
            let historyContainer = historyHeaderEl.nextElementSibling;
            if (!historyContainer || !historyContainer.classList.contains('space-y-3')) return;
            
            const historyRecords = {
                'long-high': [
                    {
                        date: '2023-05-01',
                        value: '+6.12%',
                        description: 'CT Transformer Ratio Error (Unprocessed)',
                        details: [
                            'Event Code: E-269',
                            'Line Loss Stability: 0.82'
                        ]
                    },
                    {
                        date: '2023-03-15',
                        value: '+5.87%',
                        description: 'Suspected Low-Voltage Electricity Theft (Processed)',
                        details: [
                            'Nighttime Power Usage Abnormal',
                            'Load Spike: 1 time'
                        ]
                    }
                ],
                'sudden-high': [
                    {
                        date: '2023-04-28',
                        value: '+5.55%',
                        description: 'Sudden Increase in Load (Processing)',
                        details: [
                            'Load Increase: 32.6%',
                            'Seasonal Equipment Activation'
                        ]
                    },
                    {
                        date: '2022-12-15',
                        value: '+4.28%',
                        description: 'Low-Voltage Equipment Failure (Processed)',
                        details: [
                            'Equipment Temperature Abnormal',
                            'Low-Voltage Equipment Replaced'
                        ]
                    }
                ],
                'long-negative': [
                    {
                        date: '2023-04-15',
                        value: '-4.24%',
                        description: 'Error in Line Connection (Unprocessed)',
                        details: [
                            'Connection Check Abnormal',
                            'Plan to handle on May 10th'
                        ]
                    },
                    {
                        date: '2023-03-02',
                        value: '-4.12%',
                        description: 'Incorrect Connection of Power Meter (Unprocessed)',
                        details: [
                            'E-257 Event',
                            'Involves Grid-Connected Solar Power Users'
                        ]
                    }
                ],
                'small-negative': [
                    {
                        date: '2023-04-20',
                        value: '-0.85%',
                        description: 'Deviation in Theoretical Model Calculation (Observation)',
                        details: [
                            'Load Factor Low',
                            'Model Parameter Adjustment'
                        ]
                    },
                    {
                        date: '2023-03-10',
                        value: '-0.92%',
                        description: 'Unreasonable Configuration of Current Transformer (Planning Replacement)',
                        details: [
                            'Low Secondary Load Rate',
                            'Plan to replace with suitable specifications'
                        ]
                    }
                ],
                'sudden-negative': [
                    {
                        date: '2023-04-20',
                        value: '-3.76%',
                        description: 'Fault in Power Meter Measurement (Scheduled Maintenance)',
                        details: [
                            'Fault Code E-258',
                            'Scheduled for April 25th Replacement'
                        ]
                    },
                    {
                        date: '2023-01-15',
                        value: '-2.65%',
                        description: 'Change in Ratio Not Synchronized (Processed)',
                        details: [
                            'System Parameter Update',
                            'Corrected Ratio Setting'
                        ]
                    }
                ]
            };
            
            // Clear and add new records
            historyContainer.innerHTML = '';
            const records = historyRecords[districtType];
            records.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = 'flex items-start text-xs';
                recordElement.innerHTML = `
                    <div class="w-16 font-medium text-gray-500 flex-shrink-0">${record.date}</div>
                    <div class="w-16 font-semibold ${parseFloat(record.value) > 0 ? 'text-red-500' : 'text-blue-500'} flex-shrink-0">${record.value}</div>
                    <div class="ml-2">
                        <p class="font-medium text-gray-800">${record.description}</p>
                        <div class="text-gray-500 text-[11px]">${record.details.map(d => `<p>${d}</p>`).join('')}</div>
                    </div>
                `;
                historyContainer.appendChild(recordElement);
            });
        }
          
        function updateCharts(districtType) {
            // Line loss chart data configuration
            const chartConfig = {
                'long-high': {
                    lossRates: {
                        labels: ['3/15', '3/22', '3/29', '4/5', '4/12', '4/19', '4/26', '5/3'],
                        actual: [6.8, 6.9, 6.7, 12.5, 12.8, 12.7, 12.9, 12.76],
                        theory: [6.5, 6.4, 6.3, 6.2, 6.4, 6.3, 6.35, 6.32],
                        quantity: [245, 252, 238, 450, 462, 458, 465, 460],
                        diffQuantity: [10, 18, 14, 228, 218, 213, 218, 215]
                    },
                    analysisText: [
                        'Theoretical Line Loss Calculation uses <span class="font-medium">integral current method</span>, stable at around 6%',
                        '<span class="text-red-500 font-medium">April 6th</span> began to suddenly rise, significantly increasing the difference from theoretical line loss',
                        'During this period, <span class="font-medium">user electricity consumption and load distribution</span> remained unchanged',
                        'CT current check on the secondary side found <span class="text-red-500 font-medium">problems with the ratio setting</span>'
                    ]
                },
                'sudden-high': {
                    lossRates: {
                        labels: ['4/20', '4/22', '4/24', '4/26', '4/28', '4/30', '5/2', '5/4'],
                        actual: [6.5, 6.6, 6.4, 6.7, 11.8, 11.9, 12.1, 11.95],
                        theory: [6.3, 6.3, 6.2, 6.4, 6.4, 6.4, 6.5, 6.4],
                        quantity: [210, 215, 208, 218, 380, 385, 392, 388],
                        diffQuantity: [6, 10, 6, 10, 173, 178, 182, 178]
                    },
                    analysisText: [
                        'Theoretical Line Loss Rate remains within the normal range of <span class="font-medium">6.2%-6.4%</span>',
                        '<span class="text-red-500 font-medium">April 28th</span> sudden load growth occurred, causing a sharp increase in line loss rate',
                        'From the data of power load, <span class="font-medium">load growth exceeded 30%</span>',
                        'Combined with on-site inspection, it was found that <span class="text-red-500 font-medium">seasonal air conditioning equipment</span> was widely used'
                    ]
                },
                'long-negative': {
                    lossRates: {
                        labels: ['4/10', '4/14', '4/18', '4/22', '4/26', '4/30', '5/4', '5/8'],
                        actual: [-4.1, -4.3, -4.2, -4.1, -4.4, -4.2, -4.3, -4.24],
                        theory: [5.8, 5.9, 5.8, 5.9, 5.8, 5.9, 5.8, 5.85],
                        quantity: [0, 0, 0, 0, 0, 0, 0, 0], // Placeholder, actual quantity is complex
                        diffQuantity: [-320, -330, -325, -328, -335, -327, -332, -330] // Represents negative loss amount
                    },
                    analysisText: [
                        'Theoretical Line Loss Rate fluctuates within the normal range of <span class="font-medium">5.8%-5.9%</span>',
                        'Actual Line Loss Rate remains <span class="text-blue-500 font-medium">negative</span>, indicating a systemic problem in power metering',
                        'Negative Line Loss Rate <span class="font-medium">stable and long-lasting</span>, typical characteristics of long-term negative loss',
                        'Inspection found that the meter connection at the total table end was <span class="text-red-500 font-medium">incorrect</span>, leading to abnormal recording of positive and negative power'
                    ]
                },
                'small-negative': {
                    lossRates: {
                        labels: ['3/25', '3/30', '4/5', '4/10', '4/15', '4/20', '4/25', '4/30'],
                        actual: [-0.7, -0.8, -0.9, -0.7, -0.8, -0.85, -0.9, -0.8],
                        theory: [5.1, 5.2, 5.1, 5.2, 5.15, 5.2, 5.1, 5.2],
                        quantity: [0, 0, 0, 0, 0, 0, 0, 0],
                        diffQuantity: [-85, -90, -92, -88, -91, -93, -94, -92]
                    },
                    analysisText: [
                        'Theoretical Line Loss Rate fluctuates within the range of <span class="font-medium">5.1%-5.25%</span>',
                        'Actual Line Loss Rate remains <span class="text-blue-500 font-medium">small negative</span>, and the fluctuation is very small',
                        'The load rate of the area is <span class="font-medium">low</span>, only about 15%',
                        'Comprehensive evaluation shows that <span class="text-red-500 font-medium">theoretical model has deviation when calculating at low load conditions</span> is the main cause'
                    ]
                },
                'sudden-negative': {
                    lossRates: {
                        labels: ['4/15', '4/17', '4/19', '4/21', '4/23', '4/25', '4/27', '4/29'],
                        actual: [4.9, 4.8, 4.9, -3.5, -3.8, -3.7, -3.6, -3.76],
                        theory: [4.8, 4.9, 4.8, 4.9, 4.85, 4.9, 4.8, 4.95],
                        quantity: [150, 148, 152, 0, 0, 0, 0, 0],
                        diffQuantity: [3, -3, 3, -285, -290, -288, -286, -292]
                    },
                    analysisText: [
                        'Early Line Loss Rate fluctuates within the normal range of <span class="font-medium">4.8%-5.0%</span>',
                        '<span class="text-red-500 font-medium">April 20th</span> line loss rate suddenly turned negative, and the amplitude was large',
                        'Line Loss Rate suddenly changed from <span class="font-medium">normal value to negative value</span>, changed violently',
                        'Combined with event records, it is inferred that <span class="text-red-500 font-medium">power meter measurement fault</span> is the main reason'
                    ]
                }
            };
            
            // Update line loss fluctuation tracing chart
            const config = chartConfig[districtType];
            lossAnalysisChart.data.labels = config.lossRates.labels;
            lossAnalysisChart.data.datasets[0].data = config.lossRates.actual;
            lossAnalysisChart.data.datasets[1].data = config.lossRates.theory;
            lossAnalysisChart.data.datasets[2].data = config.lossRates.quantity;
            lossAnalysisChart.data.datasets[3].data = config.lossRates.diffQuantity;
            
            // Adjust Y-axis range
            const minLoss = Math.min(...config.lossRates.actual);
            const maxLoss = Math.max(...config.lossRates.actual);
            lossAnalysisChart.options.scales.y.min = Math.floor(minLoss < 0 ? minLoss * 1.2 : 0);
            lossAnalysisChart.options.scales.y.max = Math.ceil(maxLoss * 1.2);
            
            // Update annotation point
            if (districtType === 'long-high') {
                lossAnalysisChart.options.plugins.annotation = {
                    annotations: {
                        point1: {
                            type: 'point',
                            xValue: 3,
                            yValue: 12.5,
                            backgroundColor: 'rgba(255, 99, 132, 0.25)',
                            borderWidth: 1,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            radius: 10,
                            label: {
                                content: 'Abnormal Point',
                                enabled: true,
                                position: 'top'
                            }
                        }
                    }
                };
            } else if (districtType === 'sudden-high') {
                 lossAnalysisChart.options.plugins.annotation = {
                    annotations: {
                        point1: {
                            type: 'point',
                            xValue: 4,
                            yValue: 11.8,
                            backgroundColor: 'rgba(255, 159, 64, 0.25)',
                            borderWidth: 1,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            radius: 10,
                            label: {
                                content: 'Load Increase Point',
                                enabled: true,
                                position: 'top'
                            }
                        }
                    }
                };
            } else if (districtType === 'sudden-negative') {
                lossAnalysisChart.options.plugins.annotation = {
                    annotations: {
                        point1: {
                            type: 'point',
                            xValue: 3,
                            yValue: -3.5,
                            backgroundColor: 'rgba(153, 102, 255, 0.25)',
                            borderWidth: 1,
                            borderColor: 'rgba(153, 102, 255, 1)',
                            radius: 10,
                            label: {
                                content: 'Sudden Negative Loss Point',
                                enabled: true,
                                position: 'bottom'
                            }
                        }
                    }
                };
            } else {
                lossAnalysisChart.options.plugins.annotation = { annotations: {} };
            }
            
            lossAnalysisChart.update();
            
            // Update fluctuation analysis text
            const analysisContainer = document.querySelector('.mt-4 ul');
            analysisContainer.innerHTML = config.analysisText.map(text => `<li class="text-sm text-gray-600 mb-1">${text}</li>`).join('');
            
            // Update other specific charts based on district type
            updateSpecificCharts(districtType);
        }
          
        // Update other specific charts
        function updateSpecificCharts(districtType) {
            // Here you can update other charts based on district type
            // For example, update load curve, three-phase imbalance, etc.
            
            // Example: Update load curve
            if (districtType === 'sudden-high') {
                loadCurveChart.data.datasets[0].data = [42, 30, 48, 75, 70, 82]; // Example data for sudden high
            } else if (districtType === 'long-negative') {
                loadCurveChart.data.datasets[0].data = [38, 28, 42, 62, 58, 70]; // Example data for long negative
            } else {
                loadCurveChart.data.datasets[0].data = [35, 25, 40, 60, 55, 68]; // Default data
            }
            loadCurveChart.update();
            
            // Example: Update three-phase imbalance data
            if (districtType === 'long-high') {
                phaseBalanceChart.data.datasets[0].data = [145, 98, 162]; // Example data for long high
            } else if (districtType === 'small-negative') {
                phaseBalanceChart.data.datasets[0].data = [110, 105, 115]; // Example data for small negative
            } else {
                phaseBalanceChart.data.datasets[0].data = [130, 120, 140]; // Default data
            }
            phaseBalanceChart.update();
        }
  
        // Dropdown menu behavior
        document.addEventListener('DOMContentLoaded', function() {
            const menuButton = document.getElementById('main-menu-button');
            const menuDropdown = document.getElementById('main-menu-dropdown');
            
            // Toggle dropdown menu when menu button is clicked
            menuButton.addEventListener('click', function(e) {
                e.stopPropagation();
                menuDropdown.classList.toggle('hidden');
            });
            
            // Close dropdown menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!menuButton.contains(e.target) && !menuDropdown.contains(e.target)) {
                    menuDropdown.classList.add('hidden');
                }
            });
            
            // Prevent closing dropdown menu when clicking inside
            menuDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
  
        // Multi-dimensional comparison analysis modal control
        document.addEventListener('DOMContentLoaded', function() {
            // Existing code for dropdown menu behavior...
            
            // Multi-dimensional comparison analysis modal control
            const modal = document.getElementById('analysisModal');
            const openModalBtn = document.getElementById('openAnalysisModal');
            const closeModalBtn = document.getElementById('closeAnalysisModal');
            
            // Open modal
            openModalBtn.addEventListener('click', function() {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            });
            
            // Close modal
            closeModalBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore background scrolling
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = ''; // Restore background scrolling
                }
            });
            
            // View switching functionality - maintain original logic
            const normalView = document.getElementById('normalComparisonView');
            const historyView = document.getElementById('historyComparisonView');
            const compareNormalBtn = document.getElementById('compareNormal');
            const compareHistoryBtn = document.getElementById('compareHistory');
            // Logic for switching views between normal and history comparison is handled in the other DOMContentLoaded event listener
            
            // District switching functionality
            const districtSelect = document.getElementById('districtSelect');
            districtSelect.addEventListener('change', function() {
                updateDistrictInfo(this.value);
            });
            
            // Initialize district information
            updateDistrictInfo('long-high');
            
            // Initialize tag selection functionality
            setupTagSelection();
            
            // Governance button click event
            document.getElementById('governanceButton').addEventListener('click', function() {
                const districtType = document.getElementById('districtSelect').value;
                const hasGovernance = districtType === 'sudden-high' || districtType === 'long-negative';
                
                // Get selected diagnostic tags
                const selectedTags = getSelectedTags();
                const tagsParam = encodeURIComponent(JSON.stringify(selectedTags));
                const currentLang = window.location.pathname.split('/')[1] || 'en'; // Get current language from URL
                const governancePath = `/${currentLang}/governance`;
                
                if (hasGovernance) {
                    // View existing governance suggestions
                     window.location.href = `${governancePath}?district=${districtType}&tags=${tagsParam}`;
                } else {
                    // Generate new governance suggestions
                    alert("Generating governance suggestions for the current area, you will be redirected to the governance suggestions page shortly...");
                    setTimeout(function() {
                        window.location.href = `${governancePath}?district=${districtType}&new=true&tags=${tagsParam}`;
                    }, 1500);
                }
            });
        });
  
        // Handle diagnostic tag selection functionality
        function setupTagSelection() {
            const selectAllCheckbox = document.getElementById('select-all-tags');
            
            // Select or deselect all tags
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.diagnostic-tag-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
            
            // Listen for changes to individual tags to update select all status
            document.addEventListener('change', function(e) {
                if (e.target && e.target.classList.contains('diagnostic-tag-checkbox')) {
                    updateSelectAllCheckbox();
                }
            });
        }
          
        // Update select all checkbox status
        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('select-all-tags');
            const checkboxes = document.querySelectorAll('.diagnostic-tag-checkbox');
            const checkedBoxes = document.querySelectorAll('.diagnostic-tag-checkbox:checked');
            
            // If all checkboxes are checked, select all checkbox is checked
            selectAllCheckbox.checked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;
        }
          
        // Get selected diagnostic tags
        function getSelectedTags() {
            const selectedTags = [];
            const checkedBoxes = document.querySelectorAll('.diagnostic-tag-checkbox:checked');
            checkedBoxes.forEach(checkbox => {
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                if (label) {
                    selectedTags.push(label.textContent.trim());
                }
            });
            return selectedTags;
        }

    </script>
</body>
</html> 