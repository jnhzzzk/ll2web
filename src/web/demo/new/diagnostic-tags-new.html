<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能诊断标签库</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#309C9F',
                        'primary-light': '#e6f1f1',
                        'primary-dark': '#256e70',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">智能诊断标签卡片弹窗示例</h1>
        
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">智能诊断标签</h2>
            <div class="flex flex-col space-y-3" id="diagnosticTags">
                <!-- 诊断标签会通过JavaScript动态生成 -->
            </div>
        </div>
        
        <!-- 返回按钮 -->
        <div class="mt-6">
            <a href="/cn/diagnostic.html" class="inline-flex items-center bg-primary hover:bg-primary-dark text-white py-2 px-4 rounded-md text-sm transition-colors duration-200">
                <i class="fas fa-arrow-left mr-1"></i> 返回诊断分析页面
            </a>
        </div>
    </div>
    
    <!-- 诊断标签详情弹窗测试 -->
    <div id="tagDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-3xl max-h-[90vh] overflow-auto">
            <div class="px-5 py-4 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white">
                <h2 id="tagModalTitle" class="text-lg font-medium text-gray-900">标签详情</h2>
                <button id="closeTagModal" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="tagModalContent" class="p-5">
                <!-- 弹窗内容将由JS动态生成 -->
            </div>
        </div>
    </div>
    
    <script>
        // 诊断标签数据
        const diagnosticTags = {
            // 标签库
            'tag-library': [
                {
                    title: 'CT互感器倍率错误',
                    probability: '92%',
                    icon: 'exclamation-triangle',
                    color: 'red', 
                    details: {
                        // 分析结论内容
                        analysis: [
                            "本台区线损率异常高达12.76%，远超正常水平5%",
                            "电流互感器倍率突然发生变化，由300/5变更为150/5",
                            "变压器容量与记录电流不匹配，显示电流值远低于实际值",
                            "倍率变更发生在2023-02-22期间，与线损率开始上升时间吻合",
                            "总表与子表电量反差显著，总表记录电量被倍率错误缩小了一半"
                        ],
                        // 时序图数据 - 修正为真实相关的业务数据
                        mainMeterChartData: {
                            dates: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                            usage: [1510, 1520, 1535, 765, 755, 770, 760, 780, 765, 775],
                            lossRate: [5.2, 5.4, 5.3, 11.8, 12.2, 12.5, 12.3, 12.4, 12.8, 12.7]
                        },
                        // 档案记录 - 电表事件
                        meterEvents: [
                            {
                                eventType: "PP-CT Short/Bypass occurrence",
                                eventCode: "Event-269",
                                date: "2023-02-22",
                                relatedUser: "总表"
                            },
                            {
                                eventType: "PP-CT Short/Bypass restoration",
                                eventCode: "Event-270",
                                date: "2023-02-22",
                                relatedUser: "总表"
                            },
                            {
                                eventType: "Power unbalance occurrence",
                                eventCode: "Event-281",
                                date: "2023-02-22",
                                relatedUser: "总表"
                            },
                            {
                                eventType: "Power unbalance restoration",
                                eventCode: "Event-282",
                                date: "2023-02-24",
                                relatedUser: "总表"
                            }
                        ],
                        // 档案变更记录
                        archiveChanges: [
                            {
                                eventType: "CT倍率变更",
                                date: "2023-02-22",
                                relatedUser: "总表",
                                details: "300/5 → 150/5"
                            },
                            {
                                eventType: "计量装置检修",
                                date: "2023-02-22",
                                relatedUser: "总表"
                            }
                        ]
                    }
                },
                {
                    title: '台区户表关系错误',
                    probability: '84%',
                    icon: 'file-alt',
                    color: 'orange',
                    details: {
                        // 分析结论内容
                        analysis: [
                            "台区总表记录电量与子表电量合计差异过大，线损率持续高于合理水平",
                            "发现台区内3户用电大户（编号U2023102等）未正确挂接到该台区",
                            "系统中存在总表供电但电量未计入统计的'失联表'现象",
                            "区域档案中未完整记录所有实际接入用户信息",
                            "台区改造后未及时更新户表关系"
                        ],
                        // 时序图数据
                        mainMeterChartData: {
                            dates: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                            usage: [1485, 1510, 1498, 1522, 1540, 1502, 1485, 1650, 1720, 1835],
                            lossRate: [6.1, 6.2, 6.3, 6.1, 8.4, 9.5, 9.3, 11.8, 12.5, 13.8]
                        },
                        // 档案记录 - 电表事件
                        meterEvents: [
                            {
                                eventType: "Remote connected",
                                eventCode: "Event-514",
                                date: "2023-02-18",
                                relatedUser: "用户U20230102"
                            },
                            {
                                eventType: "Phase sequence reversal occurrence",
                                eventCode: "Event-299",
                                date: "2023-02-20",
                                relatedUser: "用户U20230108"
                            },
                            {
                                eventType: "Online (GPRS)",
                                eventCode: "Event-90",
                                date: "2023-02-25",
                                relatedUser: "U2023102 (共3户)"
                            },
                            {
                                eventType: "Absence of A Phases occurrence",
                                eventCode: "Event-202",
                                date: "2023-02-25",
                                relatedUser: "用户U20230105"
                            }
                        ],
                        // 档案变更记录
                        archiveChanges: [
                            {
                                eventType: "线路改造",
                                date: "2023-02-20",
                                relatedUser: "总表"
                            },
                            {
                                eventType: "用户迁移",
                                date: "2023-02-18",
                                relatedUser: "U2023055... (共5户)"
                            },
                            {
                                eventType: "户表关系变更",
                                date: "2023-02-25",
                                relatedUser: "用户U20230102, U20230105, U20230108"
                            }
                        ]
                    }
                },
                {
                    title: '用电负荷突增',
                    probability: '78%',
                    icon: 'bolt',
                    color: 'yellow',
                    details: {
                        // 分析结论内容
                        analysis: [
                            "台区用电负荷在近期出现持续上升趋势，异常峰值高于历史均值40%以上",
                            "增长主要来自3户大型用户，单日用电量增幅超过100%",
                            "负荷突增与温度变化不匹配，排除气温因素影响",
                            "负荷变化集中在白天工作时段，疑似新增生产设备或商业活动",
                            "台区整体线损率随负荷增长有所提高，但仍处于合理范围"
                        ],
                        // 时序图数据
                        mainMeterChartData: {
                            dates: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                            usage: [1485, 1510, 1520, 1560, 1780, 1860, 2050, 2180, 2210, 2250],
                            lossRate: [5.2, 5.3, 5.3, 5.4, 5.8, 6.2, 6.5, 6.8, 6.9, 7.0]
                        },
                        // 档案记录 - 电表事件
                        meterEvents: [
                            {
                                eventType: "L1 current over occurrence",
                                eventCode: "Event-251",
                                date: "2023-02-24",
                                relatedUser: "用户U20230421"
                            },
                            {
                                eventType: "L2 current over occurrence",
                                eventCode: "Event-253",
                                date: "2023-02-24",
                                relatedUser: "用户U20230456"
                            },
                            {
                                eventType: "Power over occurrence",
                                eventCode: "Event-1023",
                                date: "2023-02-25",
                                relatedUser: "用户U20230456"
                            },
                            {
                                eventType: "Power over restoration",
                                eventCode: "Event-1024",
                                date: "2023-02-26",
                                relatedUser: "用户U20230456"
                            }
                        ],
                        // 档案变更记录
                        archiveChanges: [
                            {
                                eventType: "用户容量变更",
                                date: "2023-02-22",
                                relatedUser: "用户U20230456"
                            },
                            {
                                eventType: "设备参数变更",
                                date: "2023-02-22",
                                relatedUser: "用户U20230421"
                            },
                            {
                                eventType: "用电类型变更",
                                date: "2023-02-23",
                                relatedUser: "用户U20230456"
                            }
                        ]
                    }
                },
                {
                    title: '窃电行为突增',
                    probability: '68%',
                    icon: 'user-secret',
                    color: 'red',
                    details: {
                        // 分析结论内容
                        analysis: [
                            "台区线损率持续异常，总表与用户表计量差异持续扩大",
                            "多次检测到电表外壳开启、端子盖开启等异常事件",
                            "部分用户用电量异常下降，与季节性用电规律不符",
                            "多台电表检测到磁场干扰事件，疑似使用强磁干扰计量",
                            "夜间用电比例异常上升，但用户表记录电量未随之增加"
                        ],
                        // 时序图数据
                        mainMeterChartData: {
                            dates: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                            usage: [1485, 1490, 1520, 1540, 1550, 1570, 1590, 1610, 1630, 1650],
                            lossRate: [5.2, 5.5, 8.6, 12.3, 13.5, 14.2, 15.8, 16.3, 16.5, 17.2]
                        },
                        // 档案记录 - 电表事件
                        meterEvents: [
                            {
                                eventType: "Terminal cover opened",
                                eventCode: "Event-289",
                                date: "2023-02-22",
                                relatedUser: "用户U20230112"
                            },
                            {
                                eventType: "Strong DC magnetic field detected",
                                eventCode: "Event-297",
                                date: "2023-02-23",
                                relatedUser: "用户U20230225"
                            },
                            {
                                eventType: "Current reverse occurrence",
                                eventCode: "Event-249",
                                date: "2023-02-24",
                                relatedUser: "用户U20230336"
                            },
                            {
                                eventType: "Main cover opened",
                                eventCode: "Event-287",
                                date: "2023-02-25",
                                relatedUser: "用户U20230112"
                            }
                        ],
                        // 档案变更记录
                        archiveChanges: [
                            {
                                eventType: "CT倍率检查",
                                date: "2023-02-25",
                                relatedUser: "用户U20230112"
                            },
                            {
                                eventType: "电表检修",
                                date: "2023-02-26",
                                relatedUser: "用户U20230225, U20230336"
                            },
                            {
                                eventType: "计量装置检修",
                                date: "2023-02-27",
                                relatedUser: "多户用户"
                            }
                        ]
                    }
                },
                {
                    title: '恶劣天气影响',
                    probability: '62%',
                    icon: 'cloud-rain',
                    color: 'blue',
                    details: {
                        // 分析结论内容
                        analysis: [
                            "台区线损率随极端天气条件突然上升，历时约3-5天后恢复",
                            "线损率异常与当地气象部门记录的暴雨/大风天气高度吻合",
                            "多次记录到短时间停电和电压波动事件，符合恶劣天气特征",
                            "多个相邻台区同时出现类似线损特征，呈区域性分布",
                            "设备湿度传感器数据异常，显示设备环境潮湿"
                        ],
                        // 时序图数据
                        mainMeterChartData: {
                            dates: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                            usage: [1485, 1490, 1420, 1350, 1380, 1450, 1520, 1550, 1530, 1510],
                            lossRate: [5.2, 5.4, 9.3, 13.5, 14.2, 11.6, 8.5, 6.2, 5.8, 5.5],
                            rainfall: [0, 2, 38, 65, 43, 15, 5, 0, 0, 0],
                            windSpeed: [3.2, 5.8, 12.5, 15.2, 13.6, 8.2, 4.5, 3.6, 3.2, 3.0],
                            outageEvents: [0, 1, 12, 18, 9, 5, 2, 0, 0, 0]
                        },
                        // 档案记录 - 电表事件
                        meterEvents: [
                            {
                                eventType: "Power off (short)",
                                eventCode: "Event-7",
                                date: "2023-02-22",
                                relatedUser: "多户用户"
                            },
                            {
                                eventType: "Power on (short)",
                                eventCode: "Event-8",
                                date: "2023-02-22",
                                relatedUser: "多户用户"
                            },
                            {
                                eventType: "Offline (GPRS)",
                                eventCode: "Event-91",
                                date: "2023-02-22",
                                relatedUser: "多户用户"
                            },
                            {
                                eventType: "L1 Under voltage occurrence",
                                eventCode: "Event-5633",
                                date: "2023-02-23",
                                relatedUser: "多户用户"
                            }
                        ],
                        // 档案变更记录
                        archiveChanges: [
                            {
                                eventType: "线路检修",
                                date: "2023-02-24",
                                relatedUser: "台区配电线路"
                            },
                            {
                                eventType: "设备维护",
                                date: "2023-02-24",
                                relatedUser: "台区设备"
                            },
                            {
                                eventType: "防雷装置检查",
                                date: "2023-02-25",
                                relatedUser: "台区设备"
                            }
                        ]
                    }
                },
                {
                    title: '计量装置接线错误',
                    probability: '58%',
                    icon: 'plug',
                    color: 'red',
                    details: {
                        // 分析结论内容
                        analysis: [
                            "台区总表电能计量值突然异常下降，线损率持续为负值",
                            "总表二次侧接线相序错误，导致部分功率未被正确计量",
                            "功率因数计算结果异常，与实际负载特性不符",
                            "三相电流不平衡度正常，但计量电能显著低于预期",
                            "维护记录显示近期进行过计量装置改造，时间与异常开始吻合"
                        ],
                        // 时序图数据
                        mainMeterChartData: {
                            dates: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                            usage: [1485, 1510, 1520, 980, 960, 940, 920, 910, 900, 885],
                            lossRate: [5.2, 5.3, 5.2, -25.5, -28.3, -29.5, -30.8, -31.5, -32.2, -33.6],
                            powerFactorData: [0.92, 0.91, 0.92, 0.65, 0.62, 0.58, 0.55, 0.53, 0.52, 0.50],
                            phaseAngleData: [1.5, 1.8, 1.7, 105.0, 112.5, 118.2, 122.5, 124.1, 125.8, 126.5],
                            phaseUnbalanceData: [2.5, 2.8, 2.7, 8.5, 9.2, 9.8, 10.3, 10.8, 11.2, 11.5]
                        },
                        // 档案记录 - 电表事件
                        meterEvents: [
                            {
                                eventType: "Phase sequence reversal occurrence",
                                eventCode: "Event-299",
                                date: "2023-02-22",
                                relatedUser: "总表"
                            },
                            {
                                eventType: "Phase sequence reversal restoration",
                                eventCode: "Event-300",
                                date: "2023-02-22",
                                relatedUser: "总表"
                            },
                            {
                                eventType: "Power unbalance occurrence",
                                eventCode: "Event-281",
                                date: "2023-02-23",
                                relatedUser: "总表"
                            },
                            {
                                eventType: "Low power factor occurrence",
                                eventCode: "Event-301",
                                date: "2023-02-23",
                                relatedUser: "总表"
                            }
                        ],
                        // 档案变更记录
                        archiveChanges: [
                            {
                                eventType: "计量装置改造",
                                date: "2023-02-22",
                                relatedUser: "总表"
                            },
                            {
                                eventType: "电表检修",
                                date: "2023-02-23",
                                relatedUser: "总表"
                            },
                            {
                                eventType: "接线检查",
                                date: "2023-02-24",
                                relatedUser: "总表"
                            }
                        ]
                    }
                },
                {
                    title: '电表正反向设置错误',
                    probability: '55%',
                    icon: 'exchange-alt',
                    color: 'orange',
                    details: {
                        // 分析结论内容
                        analysis: [
                            "多次检测到电表电流反向事件，涉及多个测量点",
                            "计量数据显示部分电能被记录在反向电量中，未纳入正向用电统计",
                            "问题始于电表更换或参数设置更新后，疑似安装方向或参数配置有误",
                            "多个测量点在同一时间段发生类似问题，可能源于批量参数设置错误",
                            "电表运行状态正常，但正反向电能累积与实际用电情况不符"
                        ],
                        // 时序图数据
                        mainMeterChartData: {
                            dates: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                            usage: [1485, 1510, 1480, 1150, 1080, 1120, 1140, 1130, 1150, 1320],
                            lossRate: [5.2, 5.3, 6.8, 18.5, 22.3, 20.8, 19.5, 20.2, 18.8, 15.3]
                        },
                        // 档案记录 - 电表事件
                        meterEvents: [
                            {
                                eventType: "Current reverse occurrence",
                                eventCode: "Event-249",
                                date: "2023-02-22",
                                relatedUser: "多户用户"
                            },
                            {
                                eventType: "L1 Current reverse occurrence",
                                eventCode: "Event-257",
                                date: "2023-02-22",
                                relatedUser: "用户U20230186"
                            },
                            {
                                eventType: "L2 Current reverse occurrence",
                                eventCode: "Event-259",
                                date: "2023-02-23",
                                relatedUser: "用户U20230112"
                            },
                            {
                                eventType: "L3 Current reverse occurrence",
                                eventCode: "Event-261",
                                date: "2023-02-23",
                                relatedUser: "用户U20230112"
                            }
                        ],
                        // 档案变更记录
                        archiveChanges: [
                            {
                                eventType: "电表参数修正",
                                date: "2023-02-25",
                                relatedUser: "多户用户"
                            },
                            {
                                eventType: "电表更换",
                                date: "2023-02-22",
                                relatedUser: "用户U20230186"
                            },
                            {
                                eventType: "参数配置检查",
                                date: "2023-02-24",
                                relatedUser: "用户U20230112"
                            }
                        ]
                    }
                },
                {
                    title: '分布式能源反向计量异常',
                    probability: '50%',
                    icon: 'solar-panel',
                    color: 'green',
                    details: {
                        // 分析结论内容
                        analysis: [
                            "台区内近期新增光伏用户，但反向电能计量显著低于预期",
                            "光伏发电高峰期台区线损率异常升高，疑似反向电能计量不准确",
                            "部分光伏用户电表未正确配置双向计量功能，导致反向电能计量失准",
                            "光伏并网点电压偏高，但反向功率记录不足，计量数据不合理",
                            "台区内分布式能源用户与普通用户电量统计混乱，影响线损计算"
                        ],
                        // 时序图数据
                        mainMeterChartData: {
                            dates: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                            usage: [1485, 1510, 1490, 1450, 1430, 1410, 1380, 1350, 1320, 1290],
                            lossRate: [5.2, 5.3, 5.5, 8.7, 10.5, 11.2, 12.8, 13.5, 14.2, 15.0]
                        },
                        // 档案记录 - 电表事件
                        meterEvents: [
                            {
                                eventType: "Current reverse occurrence",
                                eventCode: "Event-249",
                                date: "2023-02-23",
                                relatedUser: "光伏用户U20230532"
                            },
                            {
                                eventType: "Power over restoration",
                                eventCode: "Event-1024",
                                date: "2023-02-24",
                                relatedUser: "光伏用户U20230546"
                            },
                            {
                                eventType: "L1 Current reverse occurrence",
                                eventCode: "Event-257",
                                date: "2023-02-24",
                                relatedUser: "光伏用户U20230532"
                            },
                            {
                                eventType: "L2 Current reverse occurrence",
                                eventCode: "Event-259",
                                date: "2023-02-24",
                                relatedUser: "光伏用户U20230546"
                            }
                        ],
                        // 档案变更记录
                        archiveChanges: [
                            {
                                eventType: "光伏并网登记",
                                date: "2023-02-20",
                                relatedUser: "用户U20230532,U20230546,U20230571"
                            },
                            {
                                eventType: "电表参数配置",
                                date: "2023-02-21",
                                relatedUser: "光伏用户电表"
                            },
                            {
                                eventType: "计量装置检查",
                                date: "2023-02-22",
                                relatedUser: "光伏用户"
                            }
                        ]
                    }
                },
                {
                    title: '时钟同步偏差',
                    probability: '45%',
                    icon: 'clock',
                    color: 'blue',
                    details: {
                        // 分析结论内容
                        analysis: [
                            "台区内多台电表时钟漂移异常，导致采集数据时间错位",
                            "时间记录与实际用电时序不匹配，造成计量统计误差",
                            "电表内部时钟漂移超过阈值，触发时钟同步告警",
                            "部分电表时钟偏差超过30分钟，远超正常误差范围",
                            "远程时钟同步操作后，线损波动恢复正常范围"
                        ],
                        // 时序图数据
                        mainMeterChartData: {
                            dates: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                            usage: [1485, 1510, 1490, 1350, 1320, 1360, 1420, 1470, 1510, 1500],
                            lossRate: [5.2, 5.3, 5.8, 9.3, 10.2, 9.5, 7.2, 6.5, 5.4, 5.3]
                        },
                        // 档案记录 - 电表事件
                        meterEvents: [
                            {
                                eventType: "Clock synchronization over threshold",
                                eventCode: "Event-1538",
                                date: "2023-02-22",
                                relatedUser: "用户U20230412,U20230425"
                            },
                            {
                                eventType: "Clock drift over threshold",
                                eventCode: "Event-12803",
                                date: "2023-02-23",
                                relatedUser: "用户U20230438"
                            },
                            {
                                eventType: "Meter alarm status word is set",
                                eventCode: "Event-12804",
                                date: "2023-02-24",
                                relatedUser: "用户U20230412"
                            },
                            {
                                eventType: "Offline (GPRS-Time out)",
                                eventCode: "Event-92",
                                date: "2023-02-24",
                                relatedUser: "多户用户"
                            }
                        ],
                        // 档案变更记录
                        archiveChanges: [
                            {
                                eventType: "电表时钟校准",
                                date: "2023-02-25",
                                relatedUser: "用户U20230412,U20230425,U20230438"
                            },
                            {
                                eventType: "时钟同步参数修改",
                                date: "2023-02-25",
                                relatedUser: "台区计量终端"
                            },
                            {
                                eventType: "通信模块维护",
                                date: "2023-02-26",
                                relatedUser: "台区多户用户"
                            }
                        ]
                    }
                },
                {
                    title: '供电半径过长',
                    probability: '40%',
                    icon: 'ruler',
                    color: 'green',
                    details: {
                        // 分析结论内容
                        analysis: [
                            "台区末端用户电压偏低，与变压器距离超过600米",
                            "线损率随用电负荷增加而显著提高，符合长半径供电特征",
                            "电压降与用户距离变压器远近呈正相关，最远户电压降达到7%以上",
                            "台区导线截面偏小，不足以支撑远距离低损耗供电",
                            "高峰负荷期间线损率偏高，远端户电压质量差"
                        ],
                        // 时序图数据
                        mainMeterChartData: {
                            dates: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                            usage: [1485, 1510, 1560, 1620, 1680, 1710, 1750, 1770, 1740, 1650],
                            lossRate: [5.2, 5.3, 6.2, 7.8, 8.5, 9.2, 9.5, 9.8, 9.3, 8.2]
                        },
                        // 档案记录 - 电表事件
                        meterEvents: [
                            {
                                eventType: "L1 Under voltage occurrence",
                                eventCode: "Event-5633",
                                date: "2023-02-25",
                                relatedUser: "远端用户U20230621"
                            },
                            {
                                eventType: "L2 Under voltage occurrence",
                                eventCode: "Event-5635",
                                date: "2023-02-25",
                                relatedUser: "远端用户U20230622"
                            },
                            {
                                eventType: "Low power factor occurrence",
                                eventCode: "Event-301",
                                date: "2023-02-25",
                                relatedUser: "用户U20230614"
                            },
                            {
                                eventType: "L1 Under voltage restoration",
                                eventCode: "Event-5634",
                                date: "2023-02-26",
                                relatedUser: "远端用户U20230621"
                            }
                        ],
                        // 档案变更记录
                        archiveChanges: [
                            {
                                eventType: "供电方案评估",
                                date: "2023-02-27",
                                relatedUser: "台区供电系统"
                            },
                            {
                                eventType: "线路检测",
                                date: "2023-02-26",
                                relatedUser: "远端用户线路"
                            },
                            {
                                eventType: "电压质量分析",
                                date: "2023-02-25",
                                relatedUser: "台区供电系统"
                            }
                        ]
                    }
                }
            ]
        };
        
        // 当前显示的异常类型
        let currentType = 'tag-library';
        
        // 显示标签
        function renderTags(type) {
            currentType = type;
            const tagContainer = document.getElementById('diagnosticTags');
            tagContainer.innerHTML = '';
            
            // 添加标签
            const tagsContainer = document.createElement('div');
            tagsContainer.className = 'flex flex-col space-y-3';
            
            diagnosticTags[type].forEach((tag, index) => {
                const tagElement = document.createElement('div');
                tagElement.className = `flex items-center p-3 bg-${tag.color}-50 border border-${tag.color}-100 rounded-lg cursor-pointer hover:shadow-md transition-shadow`;
                tagElement.innerHTML = `
                    <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-${tag.color}-100 rounded-full">
                        <i class="fas fa-${tag.icon} text-${tag.color}-500"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-${tag.color}-800">${tag.title}</h3>
                        <p class="text-xs text-${tag.color}-700 mt-1">匹配概率：${tag.probability}</p>
                    </div>
                `;
                tagElement.addEventListener('click', () => showTagDetail(type, index));
                tagsContainer.appendChild(tagElement);
            });
            
            tagContainer.appendChild(tagsContainer);
        }
        
        // 显示标签详情弹窗
        function showTagDetail(type, tagIndex) {
            const tagData = diagnosticTags[type][tagIndex];
            const modal = document.getElementById('tagDetailModal');
            const modalTitle = document.getElementById('tagModalTitle');
            const modalContent = document.getElementById('tagModalContent');
            
            // 设置标题
            modalTitle.textContent = tagData.title;
            
            // 设置弹窗内容
            modalContent.innerHTML = '';
            
            // 统一的UI框架
            modalContent.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <!-- 左侧：总表信息 -->
                        <div class="flex-1 bg-white rounded-lg shadow-sm p-4">
                            <h3 class="text-sm font-medium text-gray-800 border-b pb-2 mb-3">
                                <i class="fas fa-chart-line text-primary mr-1"></i> 总表信息
                            </h3>
                            
                            <!-- 档案信息 -->
                            <div class="mb-4">
                                <h4 class="text-xs font-medium text-gray-700 mb-2 flex items-center">
                                    <i class="fas fa-folder text-gray-500 mr-1"></i> 档案信息
                                </h4>
                                <div class="bg-gray-50 rounded p-2 text-xs">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <span class="text-gray-500">测量点ID:</span>
                                            <span class="font-medium">PNT2023063</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">所属区域:</span>
                                            <span class="font-medium">郊区东供电所</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">测量点状态:</span>
                                            <span class="font-medium">正常</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">测量点编号:</span>
                                            <span class="font-medium">MP2023063</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">电表类型:</span>
                                            <span class="font-medium">三相电表</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">通信类型:</span>
                                            <span class="font-medium">GPRS</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">用电类型:</span>
                                            <span class="font-medium">农村用电</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">电流CT变比:</span>
                                            <span class="font-medium">100/5</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">电压PT变比:</span>
                                            <span class="font-medium">10000/100</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">综合倍率:</span>
                                            <span class="font-medium">200</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">是否总表:</span>
                                            <span class="font-medium">是</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">台区编号:</span>
                                            <span class="font-medium">T2023063</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">用户数量:</span>
                                            <span class="font-medium">63户</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">变压器容量:</span>
                                            <span class="font-medium">160kVA</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">经度:</span>
                                            <span class="font-medium">120.3456</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">纬度:</span>
                                            <span class="font-medium">30.3278</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 采集数据 -->
                            <div class="mb-4">
                                <h4 class="text-xs font-medium text-gray-700 mb-2 flex items-center">
                                    <i class="fas fa-database text-gray-500 mr-1"></i> 采集数据
                                </h4>
                                <div class="bg-gray-50 rounded p-2 text-xs">
                                    <div class="text-xs font-medium text-gray-700 mb-2">总表上月数据</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <span class="text-gray-500">月用电量:</span>
                                            <span class="font-medium">49,500 kWh</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">最大负荷:</span>
                                            <span class="font-medium">170 kW</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">日正向有功累计:</span>
                                            <span class="font-medium">1,650 kWh/天</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">日反向有功累计:</span>
                                            <span class="font-medium">0 kWh/天</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">台区供电量:</span>
                                            <span class="font-medium">49,500 kWh</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">台区用电量:</span>
                                            <span class="font-medium">45,441 kWh</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">采集成功率:</span>
                                            <span class="font-medium">100%</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">线损率:</span>
                                            <span class="font-medium text-orange-600">8.2%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- 关键指标可视化 -->
                                    <div class="mt-4 border-t border-gray-200 pt-3">
                                        <h4 class="text-xs font-medium text-gray-700 mb-2 flex items-center">
                                            <i class="fas fa-chart-line text-gray-500 mr-1"></i> 关键指标
                                        </h4>
                                        <div class="bg-gray-50 rounded p-2 text-xs">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-gray-600 font-medium chart-title" data-chart-id="mainMeterTimeSeriesChart">电流/功率因数日维度变化</span>
                                            </div>
                                            <div class="h-40">
                                                <canvas id="mainMeterTimeSeriesChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 档案记录 -->
                            <div>
                                <h4 class="text-xs font-medium text-gray-700 mb-2 flex items-center">
                                    <i class="fas fa-file-alt text-gray-500 mr-1"></i> 档案记录
                                </h4>
                                <div class="bg-gray-50 rounded p-2 text-xs space-y-3">
                                    <!-- 电表事件记录子项 -->
                                    <div>
                                        <div class="text-xs font-medium text-gray-600 mb-1">电表事件记录</div>
                                        <table class="min-w-full text-xs">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">事件类型</th>
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">事件码</th>
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">日期</th>
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">相关用户</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${tagData.details && tagData.details.meterEvents ? tagData.details.meterEvents.map(event => `
                                                <tr>
                                                    <td class="py-1 px-2">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-tools text-blue-500 mr-1"></i>
                                                            <span class="font-medium">${event.eventType}</span>
                                                        </div>
                                                    </td>
                                                    <td class="py-1 px-2">
                                                        <span class="px-1.5 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">${event.eventCode}</span>
                                                    </td>
                                                    <td class="py-1 px-2 text-gray-500">${event.date}</td>
                                                    <td class="py-1 px-2 text-gray-500">${event.relatedUser}</td>
                                                </tr>
                                                `).join('') : ''}
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- 档案变更记录子项 -->
                                    <div>
                                        <div class="text-xs font-medium text-gray-600 mb-1">档案变更记录</div>
                                        <table class="min-w-full text-xs">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">事件类型</th>
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">日期</th>
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">相关用户</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${tagData.details && tagData.details.archiveChanges ? tagData.details.archiveChanges.map(event => `
                                                <tr>
                                                    <td class="py-1 px-2">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-route text-purple-500 mr-1"></i>
                                                            <span class="font-medium">${event.eventType}</span>
                                                        </div>
                                                    </td>
                                                    <td class="py-1 px-2 text-gray-500">${event.date}</td>
                                                    <td class="py-1 px-2 text-gray-500">${event.relatedUser}</td>
                                                </tr>
                                                `).join('') : ''}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右侧：子表信息 -->
                        <div class="flex-1 bg-white rounded-lg shadow-sm p-4">
                            <h3 class="text-sm font-medium text-gray-800 border-b pb-2 mb-3">
                                <i class="fas fa-table text-primary mr-1"></i> 子表信息
                                <span class="text-xs font-normal text-gray-500">(165户)</span>
                            </h3>
                            
                            <!-- 档案信息 -->
                            <div class="mb-4">
                                <h4 class="text-xs font-medium text-gray-700 mb-2 flex items-center">
                                    <i class="fas fa-folder text-gray-500 mr-1"></i> 档案信息
                                </h4>
                                <div class="bg-gray-50 rounded p-2 text-xs">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <span class="text-gray-500">单相表数量:</span>
                                            <span class="font-medium">118台</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">三相表数量:</span>
                                            <span class="font-medium">21台</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">最新接入日期:</span>
                                            <span class="font-medium">2023-02-25</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">漏挂接表计:</span>
                                            <span class="font-medium text-orange-600">3台</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 采集数据 -->
                            <div class="mb-4">
                                <h4 class="text-xs font-medium text-gray-700 mb-2 flex items-center">
                                    <i class="fas fa-database text-gray-500 mr-1"></i> 采集数据
                                </h4>
                                <div class="bg-gray-50 rounded p-2 text-xs">
                                    <div class="text-xs font-medium text-gray-700 mb-2">用户上月数据</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <span class="text-gray-500">月用电量:</span>
                                            <span class="font-medium">45,441 kWh</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">平均负荷:</span>
                                            <span class="font-medium">3.02 kW/户</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">日正向有功累计:</span>
                                            <span class="font-medium">1,515 kWh/天</span>
                                        </div>
                                        
                                        <div>
                                            <span class="text-gray-500">平均采集成功率:</span>
                                            <span class="font-medium">100%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- 关键指标可视化 -->
                                    <div class="mt-4 border-t border-gray-200 pt-3">
                                        <h4 class="text-xs font-medium text-gray-700 mb-2 flex items-center">
                                            <i class="fas fa-chart-line text-gray-500 mr-1"></i> 关键指标
                                        </h4>
                                        <div class="bg-gray-50 rounded p-2 text-xs">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-gray-600 font-medium chart-title" data-chart-id="subMeterTimeSeriesChart">三相电流不平衡度变化</span>
                                            </div>
                                            <div class="h-40">
                                                <canvas id="subMeterTimeSeriesChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 档案记录 -->
                            <div>
                                <h4 class="text-xs font-medium text-gray-700 mb-2 flex items-center">
                                    <i class="fas fa-file-alt text-gray-500 mr-1"></i> 档案记录
                                </h4>
                                <div class="bg-gray-50 rounded p-2 text-xs space-y-3">
                                    <!-- 电表事件记录子项 -->
                                    <div>
                                        <div class="text-xs font-medium text-gray-600 mb-1">电表事件记录</div>
                                        <table class="min-w-full text-xs">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">事件类型</th>
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">事件码</th>
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">日期</th>
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">相关用户</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td class="py-1 px-2">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-tools text-blue-500 mr-1"></i>
                                                            <span class="font-medium">Current unbalance occurrence</span>
                                                        </div>
                                                    </td>
                                                    <td class="py-1 px-2">
                                                        <span class="px-1.5 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">Event-279</span>
                                                    </td>
                                                    <td class="py-1 px-2 text-gray-500">2023-02-23</td>
                                                    <td class="py-1 px-2 text-gray-500">用户U20230195</td>
                                                </tr>
                                                <tr>
                                                    <td class="py-1 px-2">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-tools text-blue-500 mr-1"></i>
                                                            <span class="font-medium">Current unbalance restoration</span>
                                                        </div>
                                                    </td>
                                                    <td class="py-1 px-2">
                                                        <span class="px-1.5 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">Event-280</span>
                                                    </td>
                                                    <td class="py-1 px-2 text-gray-500">2023-02-24</td>
                                                    <td class="py-1 px-2 text-gray-500">用户U20230195</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- 档案变更记录子项 -->
                                    <div>
                                        <div class="text-xs font-medium text-gray-600 mb-1">档案变更记录</div>
                                        <table class="min-w-full text-xs">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">事件类型</th>
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">日期</th>
                                                    <th class="py-1.5 px-2 text-left text-gray-600 font-medium">相关用户</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td class="py-1 px-2">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-user-plus text-green-500 mr-1"></i>
                                                            <span class="font-medium">用户添加</span>
                                                        </div>
                                                    </td>
                                                    <td class="py-1 px-2 text-gray-500">2023-02-25</td>
                                                    <td class="py-1 px-2 text-gray-500">U20230102, U20230105, U20230108</td>
                                                </tr>
                                                <tr>
                                                    <td class="py-1 px-2">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-project-diagram text-blue-500 mr-1"></i>
                                                            <span class="font-medium">台区拓扑结构变更</span>
                                                        </div>
                                                    </td>
                                                    <td class="py-1 px-2 text-gray-500">2023-02-20</td>
                                                    <td class="py-1 px-2 text-gray-500">T2023084台区</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 错误分析与治理建议 -->
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 左侧：分析结论 -->
                        <div class="bg-white rounded-lg shadow-sm p-4">
                            <h3 class="text-sm font-medium text-gray-800 border-b pb-2 mb-3">
                                <i class="fas fa-chart-pie text-primary mr-1"></i> 分析结论
                            </h3>
                            <div class="text-xs text-gray-600">
                                <ul class="list-disc pl-5 space-y-1">
                                    ${tagData.details && tagData.details.analysis ? tagData.details.analysis.map(item => `
                                    <li>${item}</li>
                                    `).join('') : '<li>无分析结论</li>'}
                                </ul>
                            </div>
                        </div>
                        
                        <!-- 右侧：匹配概率 -->
                        <div class="bg-white rounded-lg shadow-sm p-4">
                            <h3 class="text-sm font-medium text-gray-800 border-b pb-2 mb-3">
                                <i class="fas fa-percentage text-primary mr-1"></i> 匹配概率
                            </h3>
                            <div class="text-xs text-gray-600" id="probabilityContent">
                                <!-- 匹配概率内容将根据当前标签动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 显示弹窗
            modal.classList.remove('hidden');
            
            // 根据标签类型生成匹配概率表格
            const probabilityContent = document.getElementById('probabilityContent');
            const tagTitle = tagData.title;
            const tagProbability = tagData.probability;
            
            // 为不同标签生成对应的匹配概率内容
            let probabilityHtml = '';
            
            if (tagTitle === 'CT互感器倍率错误') {
                probabilityHtml = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="text-left py-1 px-2 font-medium">特征</th>
                                <th class="text-center py-1 px-2 font-medium">权重</th>
                                <th class="text-right py-1 px-2 font-medium">发生概率</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-1 px-2">线损率异常持续</td>
                                <td class="text-center py-1 px-2">35%</td>
                                <td class="text-right py-1 px-2 text-orange-600">32.2%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">CT变更记录</td>
                                <td class="text-center py-1 px-2">30%</td>
                                <td class="text-right py-1 px-2 text-orange-600">29.4%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">电流异常事件</td>
                                <td class="text-center py-1 px-2">20%</td>
                                <td class="text-right py-1 px-2 text-orange-600">18.5%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">功率因数异常</td>
                                <td class="text-center py-1 px-2">10%</td>
                                <td class="text-right py-1 px-2 text-orange-600">8.7%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">电能计量突变</td>
                                <td class="text-center py-1 px-2">5%</td>
                                <td class="text-right py-1 px-2 text-orange-600">3.2%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-medium text-base">
                                <td colspan="2" class="py-2 px-2 text-right">匹配概率</td>
                                <td class="py-2 px-2 text-right text-orange-600">92%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            } else if (tagTitle === '台区户表关系错误') {
                probabilityHtml = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="text-left py-1 px-2 font-medium">特征</th>
                                <th class="text-center py-1 px-2 font-medium">权重</th>
                                <th class="text-right py-1 px-2 font-medium">发生概率</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-1 px-2">台区线损率持续异常</td>
                                <td class="text-center py-1 px-2">40%</td>
                                <td class="text-right py-1 px-2 text-orange-600">35%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">子表用电量合计偏低</td>
                                <td class="text-center py-1 px-2">25%</td>
                                <td class="text-right py-1 px-2 text-orange-600">22%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">台区改造后户表关系变更</td>
                                <td class="text-center py-1 px-2">18%</td>
                                <td class="text-right py-1 px-2 text-orange-600">15%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">用户上线通信事件记录</td>
                                <td class="text-center py-1 px-2">10%</td>
                                <td class="text-right py-1 px-2 text-orange-600">8%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">相位关系异常</td>
                                <td class="text-center py-1 px-2">7%</td>
                                <td class="text-right py-1 px-2 text-orange-600">4%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-medium text-base">
                                <td colspan="2" class="py-2 px-2 text-right">匹配概率</td>
                                <td class="py-2 px-2 text-right text-orange-600">84%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            } else if (tagTitle === '用电负荷突增') {
                probabilityHtml = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="text-left py-1 px-2 font-medium">特征</th>
                                <th class="text-center py-1 px-2 font-medium">权重</th>
                                <th class="text-right py-1 px-2 font-medium">发生概率</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-1 px-2">电流过载事件频发</td>
                                <td class="text-center py-1 px-2">32%</td>
                                <td class="text-right py-1 px-2 text-orange-600">25%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">用电量突增超过40%</td>
                                <td class="text-center py-1 px-2">25%</td>
                                <td class="text-right py-1 px-2 text-orange-600">20%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">工业用户容量变更记录</td>
                                <td class="text-center py-1 px-2">20%</td>
                                <td class="text-right py-1 px-2 text-orange-600">15%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">负荷变化集中在工作时段</td>
                                <td class="text-center py-1 px-2">15%</td>
                                <td class="text-right py-1 px-2 text-orange-600">10%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">线损率变化趋势合理</td>
                                <td class="text-center py-1 px-2">8%</td>
                                <td class="text-right py-1 px-2 text-orange-600">8%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-medium text-base">
                                <td colspan="2" class="py-2 px-2 text-right">匹配概率</td>
                                <td class="py-2 px-2 text-right text-orange-600">78%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            } else if (tagTitle === '窃电行为突增') {
                probabilityHtml = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="text-left py-1 px-2 font-medium">特征</th>
                                <th class="text-center py-1 px-2 font-medium">权重</th>
                                <th class="text-right py-1 px-2 font-medium">发生概率</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-1 px-2">线损率持续异常高</td>
                                <td class="text-center py-1 px-2">30%</td>
                                <td class="text-right py-1 px-2 text-orange-600">22%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">电表开盖/端子盖开启事件</td>
                                <td class="text-center py-1 px-2">25%</td>
                                <td class="text-right py-1 px-2 text-orange-600">18%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">强磁场干扰事件记录</td>
                                <td class="text-center py-1 px-2">20%</td>
                                <td class="text-right py-1 px-2 text-orange-600">15%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">电流反向事件</td>
                                <td class="text-center py-1 px-2">15%</td>
                                <td class="text-right py-1 px-2 text-orange-600">8%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">线损与负荷变化不符</td>
                                <td class="text-center py-1 px-2">10%</td>
                                <td class="text-right py-1 px-2 text-orange-600">5%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-medium text-base">
                                <td colspan="2" class="py-2 px-2 text-right">匹配概率</td>
                                <td class="py-2 px-2 text-right text-orange-600">68%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            } else if (tagTitle === '恶劣天气影响') {
                probabilityHtml = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="text-left py-1 px-2 font-medium">特征</th>
                                <th class="text-center py-1 px-2 font-medium">权重</th>
                                <th class="text-right py-1 px-2 font-medium">发生概率</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-1 px-2">线损与气象数据高度相关</td>
                                <td class="text-center py-1 px-2">28%</td>
                                <td class="text-right py-1 px-2 text-orange-600">20%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">多户用户同时掉线/停电</td>
                                <td class="text-center py-1 px-2">24%</td>
                                <td class="text-right py-1 px-2 text-orange-600">15%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">区域性线损异常特征</td>
                                <td class="text-center py-1 px-2">20%</td>
                                <td class="text-right py-1 px-2 text-orange-600">12%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">设备保护动作记录</td>
                                <td class="text-center py-1 px-2">16%</td>
                                <td class="text-right py-1 px-2 text-orange-600">8%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">线损恢复趋势明显</td>
                                <td class="text-center py-1 px-2">12%</td>
                                <td class="text-right py-1 px-2 text-orange-600">7%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-medium text-base">
                                <td colspan="2" class="py-2 px-2 text-right">匹配概率</td>
                                <td class="py-2 px-2 text-right text-orange-600">62%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            } else if (tagTitle === '计量装置接线错误') {
                probabilityHtml = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="text-left py-1 px-2 font-medium">特征</th>
                                <th class="text-center py-1 px-2 font-medium">权重</th>
                                <th class="text-right py-1 px-2 font-medium">发生概率</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-1 px-2">相序异常事件记录</td>
                                <td class="text-center py-1 px-2">30%</td>
                                <td class="text-right py-1 px-2 text-orange-600">20%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">功率因数异常</td>
                                <td class="text-center py-1 px-2">25%</td>
                                <td class="text-right py-1 px-2 text-orange-600">15%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">计量装置改造记录</td>
                                <td class="text-center py-1 px-2">20%</td>
                                <td class="text-right py-1 px-2 text-orange-600">12%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">线损率持续为负</td>
                                <td class="text-center py-1 px-2">15%</td>
                                <td class="text-right py-1 px-2 text-orange-600">6%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">电能计量突变</td>
                                <td class="text-center py-1 px-2">10%</td>
                                <td class="text-right py-1 px-2 text-orange-600">5%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-medium text-base">
                                <td colspan="2" class="py-2 px-2 text-right">匹配概率</td>
                                <td class="py-2 px-2 text-right text-orange-600">58%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            } else if (tagTitle === '电表正反向设置错误') {
                probabilityHtml = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="text-left py-1 px-2 font-medium">特征</th>
                                <th class="text-center py-1 px-2 font-medium">权重</th>
                                <th class="text-right py-1 px-2 font-medium">发生概率</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-1 px-2">电流反向事件频发</td>
                                <td class="text-center py-1 px-2">30%</td>
                                <td class="text-right py-1 px-2 text-orange-600">18%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">反向电量异常增加</td>
                                <td class="text-center py-1 px-2">25%</td>
                                <td class="text-right py-1 px-2 text-orange-600">15%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">电表参数批量修改记录</td>
                                <td class="text-center py-1 px-2">20%</td>
                                <td class="text-right py-1 px-2 text-orange-600">12%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">电表更换后异常</td>
                                <td class="text-center py-1 px-2">15%</td>
                                <td class="text-right py-1 px-2 text-orange-600">6%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">线损率持续异常</td>
                                <td class="text-center py-1 px-2">10%</td>
                                <td class="text-right py-1 px-2 text-orange-600">4%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-medium text-base">
                                <td colspan="2" class="py-2 px-2 text-right">匹配概率</td>
                                <td class="py-2 px-2 text-right text-orange-600">55%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            } else if (tagTitle === '分布式能源反向计量异常') {
                probabilityHtml = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="text-left py-1 px-2 font-medium">特征</th>
                                <th class="text-center py-1 px-2 font-medium">权重</th>
                                <th class="text-right py-1 px-2 font-medium">发生概率</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-1 px-2">电流反向事件频发</td>
                                <td class="text-center py-1 px-2">25%</td>
                                <td class="text-right py-1 px-2 text-orange-600">16%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">光伏并网登记记录</td>
                                <td class="text-center py-1 px-2">22%</td>
                                <td class="text-right py-1 px-2 text-orange-600">12%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">反向电量异常低</td>
                                <td class="text-center py-1 px-2">20%</td>
                                <td class="text-right py-1 px-2 text-orange-600">10%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">线损率持续升高</td>
                                <td class="text-center py-1 px-2">18%</td>
                                <td class="text-right py-1 px-2 text-orange-600">7%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">电表参数配置记录</td>
                                <td class="text-center py-1 px-2">15%</td>
                                <td class="text-right py-1 px-2 text-orange-600">5%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-medium text-base">
                                <td colspan="2" class="py-2 px-2 text-right">匹配概率</td>
                                <td class="py-2 px-2 text-right text-orange-600">50%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            } else if (tagTitle === '时钟同步偏差') {
                probabilityHtml = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="text-left py-1 px-2 font-medium">特征</th>
                                <th class="text-center py-1 px-2 font-medium">权重</th>
                                <th class="text-right py-1 px-2 font-medium">发生概率</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-1 px-2">时钟偏差事件记录</td>
                                <td class="text-center py-1 px-2">30%</td>
                                <td class="text-right py-1 px-2 text-orange-600">15%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">采集成功率波动</td>
                                <td class="text-center py-1 px-2">25%</td>
                                <td class="text-right py-1 px-2 text-orange-600">12%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">电表时钟校准记录</td>
                                <td class="text-center py-1 px-2">20%</td>
                                <td class="text-right py-1 px-2 text-orange-600">10%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">线损率临时波动</td>
                                <td class="text-center py-1 px-2">15%</td>
                                <td class="text-right py-1 px-2 text-orange-600">5%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">电表时钟同步参数修改</td>
                                <td class="text-center py-1 px-2">10%</td>
                                <td class="text-right py-1 px-2 text-orange-600">3%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-medium text-base">
                                <td colspan="2" class="py-2 px-2 text-right">匹配概率</td>
                                <td class="py-2 px-2 text-right text-orange-600">45%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            } else if (tagTitle === '供电半径过长') {
                probabilityHtml = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="text-left py-1 px-2 font-medium">特征</th>
                                <th class="text-center py-1 px-2 font-medium">权重</th>
                                <th class="text-right py-1 px-2 font-medium">发生概率</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-1 px-2">末端用户电压偏低告警</td>
                                <td class="text-center py-1 px-2">35%</td>
                                <td class="text-right py-1 px-2 text-orange-600">15%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">负荷增长导致线损率上升</td>
                                <td class="text-center py-1 px-2">25%</td>
                                <td class="text-right py-1 px-2 text-orange-600">10%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">用户距离与电压降相关性</td>
                                <td class="text-center py-1 px-2">20%</td>
                                <td class="text-right py-1 px-2 text-orange-600">8%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">功率因数低告警</td>
                                <td class="text-center py-1 px-2">12%</td>
                                <td class="text-right py-1 px-2 text-orange-600">4%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">线路分布地理特征</td>
                                <td class="text-center py-1 px-2">8%</td>
                                <td class="text-right py-1 px-2 text-orange-600">3%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-medium text-base">
                                <td colspan="2" class="py-2 px-2 text-right">匹配概率</td>
                                <td class="py-2 px-2 text-right text-orange-600">40%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            } else if (tagTitle === '低压设备故障') {
                // 低压设备故障的图表配置
                const chartData = {
                    labels: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                    voltageData: [220, 218, 215, 208, 205, 202, 200, 198, 195, 192],
                    currentData: [150, 155, 160, 165, 170, 175, 180, 185, 190, 195],
                    powerFactorData: [0.92, 0.91, 0.90, 0.87, 0.85, 0.83, 0.82, 0.81, 0.80, 0.79],
                    harmonicContentData: [2.1, 2.2, 2.5, 3.2, 3.8, 4.3, 4.8, 5.2, 5.5, 5.8],
                    equipmentTempData: [28, 30, 35, 42, 48, 55, 62, 68, 72, 76],
                    phaseImbalanceData: [1.2, 1.5, 2.0, 2.8, 3.5, 4.2, 5.0, 5.8, 6.5, 7.2],
                    lossRateData: [5.2, 5.3, 7.8, 8.5, 8.7, 9.2, 9.5, 9.3, 8.9, 8.6]
                };
                
                // 特定标签数据覆盖
                if (tagData.details && tagData.details.mainMeterChartData) {
                    chartData.labels = tagData.details.mainMeterChartData.dates;
                    if (tagData.details.mainMeterChartData.voltageData) {
                        chartData.voltageData = tagData.details.mainMeterChartData.voltageData;
                    }
                    if (tagData.details.mainMeterChartData.currentData) {
                        chartData.currentData = tagData.details.mainMeterChartData.currentData;
                    }
                    if (tagData.details.mainMeterChartData.powerFactorData) {
                        chartData.powerFactorData = tagData.details.mainMeterChartData.powerFactorData;
                    }
                    if (tagData.details.mainMeterChartData.harmonicContentData) {
                        chartData.harmonicContentData = tagData.details.mainMeterChartData.harmonicContentData;
                    }
                    if (tagData.details.mainMeterChartData.equipmentTempData) {
                        chartData.equipmentTempData = tagData.details.mainMeterChartData.equipmentTempData;
                    }
                    if (tagData.details.mainMeterChartData.phaseImbalanceData) {
                        chartData.phaseImbalanceData = tagData.details.mainMeterChartData.phaseImbalanceData;
                    }
                    if (tagData.details.mainMeterChartData.lossRate) {
                        chartData.lossRateData = tagData.details.mainMeterChartData.lossRate;
                    }
                }
                
                // 更新图表标题
                document.querySelector('.text-gray-600.font-medium').textContent = '设备温度与谐波含量对比';
                
                new Chart(mainMeterCtx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: '设备温度 (°C)',
                                data: chartData.equipmentTempData,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                fill: false,
                                tension: 0.3,
                                yAxisID: 'y'
                            },
                            {
                                label: '谐波含量 (%)',
                                data: chartData.harmonicContentData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: false,
                                tension: 0.3,
                                yAxisID: 'y1'
                            },
                            {
                                label: '线损率 (%)',
                                data: chartData.lossRateData,
                                borderColor: '#16a34a',
                                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                fill: false,
                                tension: 0.3,
                                    borderDash: [5, 5],
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                align: 'end',
                                labels: {
                                    boxWidth: 10,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    font: {
                                        size: 8
                                    }
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '温度 (°C)',
                                    font: {
                                        size: 8
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: 8
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '百分比 (%)',
                                    font: {
                                        size: 8
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    font: {
                                        size: 8
                                    }
                                }
                            }
                        }
                    }
                });

                // 更新子表图表标题
                document.querySelectorAll('.text-gray-600.font-medium')[1].textContent = '功率因数与三相不平衡度变化';
                
                new Chart(subMeterCtx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: '功率因数',
                                data: chartData.powerFactorData,
                                borderColor: '#16a34a',
                                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                fill: true,
                                tension: 0.3,
                                yAxisID: 'y'
                            },
                            {
                                label: '三相不平衡度 (%)',
                                data: chartData.phaseImbalanceData,
                                borderColor: '#f59e0b',
                                backgroundColor: 'transparent',
                                fill: false,
                                tension: 0.3,
                                borderDash: [5, 5],
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                align: 'end',
                                labels: {
                                    boxWidth: 10,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    font: {
                                        size: 8
                                    }
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                min: 0.5,
                                max: 1.0,
                                title: {
                                    display: true,
                                    text: '功率因数',
                                    font: {
                                        size: 8
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: 8
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '不平衡度 (%)',
                                    font: {
                                        size: 8
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    font: {
                                        size: 8
                                    }
                                }
                            }
                        }
                    }
                });
            } else if (tagTitle === '窃电行为突增') {
                // 窃电行为突增的图表配置
                    const chartData = {
                    labels: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                    lossRateData: [5.2, 5.5, 8.6, 12.3, 13.5, 14.2, 15.8, 16.3, 16.5, 17.2],
                    meterEventsData: [2, 3, 5, 8, 10, 12, 15, 14, 16, 18],
                    dayTimeRatio: [0.72, 0.71, 0.69, 0.65, 0.62, 0.58, 0.55, 0.54, 0.52, 0.50],
                    nightTimeRatio: [0.28, 0.29, 0.31, 0.35, 0.38, 0.42, 0.45, 0.46, 0.48, 0.50],
                    abnormalUsersCount: [2, 3, 5, 8, 12, 15, 18, 20, 22, 25],
                    magneticFieldEvents: [0, 1, 2, 3, 5, 6, 7, 8, 9, 10]
                    };
                    
                    // 特定标签数据覆盖
                    if (tagData.details && tagData.details.mainMeterChartData) {
                        chartData.labels = tagData.details.mainMeterChartData.dates;
                    if (tagData.details.mainMeterChartData.lossRate) {
                        chartData.lossRateData = tagData.details.mainMeterChartData.lossRate;
                    }
                    if (tagData.details.mainMeterChartData.meterEventsData) {
                        chartData.meterEventsData = tagData.details.mainMeterChartData.meterEventsData;
                    }
                    if (tagData.details.mainMeterChartData.dayTimeRatio) {
                        chartData.dayTimeRatio = tagData.details.mainMeterChartData.dayTimeRatio;
                    }
                    if (tagData.details.mainMeterChartData.nightTimeRatio) {
                        chartData.nightTimeRatio = tagData.details.mainMeterChartData.nightTimeRatio;
                    }
                    if (tagData.details.mainMeterChartData.abnormalUsersCount) {
                        chartData.abnormalUsersCount = tagData.details.mainMeterChartData.abnormalUsersCount;
                    }
                    if (tagData.details.mainMeterChartData.magneticFieldEvents) {
                        chartData.magneticFieldEvents = tagData.details.mainMeterChartData.magneticFieldEvents;
                    }
                }
                
                // 更新图表标题 - 总表
                document.querySelector('.text-gray-600.font-medium').textContent = '电表异常事件与线损率关系';
                
                // 总表图表 - 电表异常事件与线损率关系
                    new Chart(mainMeterCtx, {
                        type: 'line',
                        data: {
                            labels: chartData.labels,
                            datasets: [
                                {
                                label: '电表异常事件数量',
                                data: chartData.meterEventsData,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: false,
                                    tension: 0.3,
                                    yAxisID: 'y'
                                },
                                {
                                label: '磁场干扰事件数量',
                                data: chartData.magneticFieldEvents,
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                fill: false,
                                tension: 0.3,
                                borderDash: [5, 5],
                                yAxisID: 'y'
                            },
                            {
                                label: '线损率 (%)',
                                data: chartData.lossRateData,
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    fill: false,
                                    tension: 0.3,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    align: 'end',
                                    labels: {
                                        boxWidth: 10,
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                    text: '事件数量',
                                        font: {
                                            size: 8
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            size: 8
                                    }
                                    },
                                beginAtZero: true
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                    text: '线损率 (%)',
                                        font: {
                                            size: 8
                                        }
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    },
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                    }
                                }
                            }
                        }
                    });

                // 更新图表标题 - 子表
                document.querySelectorAll('.text-gray-600.font-medium')[1].textContent = '日间/夜间用电比例变化';
                    
                // 子表图表 - 日间/夜间用电比例变化
                    new Chart(subMeterCtx, {
                        type: 'bar',
                        data: {
                            labels: chartData.labels,
                            datasets: [
                                {
                                label: '日间用电比例',
                                data: chartData.dayTimeRatio,
                                backgroundColor: 'rgba(251, 191, 36, 0.6)',
                                borderColor: 'rgba(251, 191, 36, 1)',
                                borderWidth: 1,
                                stack: 'Stack 0'
                            },
                            {
                                label: '夜间用电比例',
                                data: chartData.nightTimeRatio,
                                backgroundColor: 'rgba(29, 78, 216, 0.6)',
                                borderColor: 'rgba(29, 78, 216, 1)',
                                borderWidth: 1,
                                stack: 'Stack 0'
                            },
                            {
                                label: '异常用户数量',
                                data: chartData.abnormalUsersCount,
                                type: 'line',
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.3,
                                yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    align: 'end',
                                    labels: {
                                        boxWidth: 10,
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                    }
                                },
                                y: {
                                type: 'linear',
                                stacked: true,
                                display: true,
                                position: 'left',
                                min: 0,
                                max: 1,
                                    title: {
                                        display: true,
                                    text: '用电比例',
                                        font: {
                                            size: 8
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            size: 8
                                    },
                                    callback: function(value) {
                                        return Math.round(value * 100) + '%';
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                    title: {
                                        display: true,
                                    text: '异常用户数',
                                        font: {
                                            size: 8
                                        }
                                    },
                                grid: {
                                    drawOnChartArea: false
                                    },
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                },
                                beginAtZero: true
                                }
                            }
                        }
                    });
            } else if (tagTitle === '恶劣天气影响') {
                // 恶劣天气影响的图表配置
                    const chartData = {
                        labels: ['2月20日', '2月21日', '2月22日', '2月23日', '2月24日', '2月25日', '2月26日', '2月27日', '2月28日', '3月1日'],
                    rainfallData: [0, 2, 38, 65, 43, 15, 5, 0, 0, 0],
                    windSpeedData: [3.2, 5.8, 12.5, 15.2, 13.6, 8.2, 4.5, 3.6, 3.2, 3.0],
                    outageEventsData: [0, 1, 12, 18, 9, 5, 2, 0, 0, 0],
                    lossRateData: [5.2, 5.4, 9.3, 13.5, 14.2, 11.6, 8.5, 6.2, 5.8, 5.5]
                    };
                    
                    // 特定标签数据覆盖
                    if (tagData.details && tagData.details.mainMeterChartData) {
                        chartData.labels = tagData.details.mainMeterChartData.dates;
                    if (tagData.details.mainMeterChartData.rainfall) {
                        chartData.rainfallData = tagData.details.mainMeterChartData.rainfall;
                    }
                    if (tagData.details.mainMeterChartData.windSpeed) {
                        chartData.windSpeedData = tagData.details.mainMeterChartData.windSpeed;
                    }
                    if (tagData.details.mainMeterChartData.outageEvents) {
                        chartData.outageEventsData = tagData.details.mainMeterChartData.outageEvents;
                    }
                    if (tagData.details.mainMeterChartData.lossRate) {
                        chartData.lossRateData = tagData.details.mainMeterChartData.lossRate;
                    }
                    }
                    
                    // 更新图表标题
                document.querySelector('.text-gray-600.font-medium').textContent = '气象数据与电网运行状况相关性';
                    
                    new Chart(mainMeterCtx, {
                        type: 'line',
                        data: {
                            labels: chartData.labels,
                            datasets: [
                                {
                                label: '日降雨量 (mm)',
                                data: chartData.rainfallData,
                                    borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                    fill: true,
                                tension: 0.4,
                                    yAxisID: 'y'
                                },
                                {
                                label: '线损率 (%)',
                                data: chartData.lossRateData,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    fill: false,
                                tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    align: 'end',
                                    labels: {
                                        boxWidth: 10,
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                    text: '降雨量 (mm)',
                                        font: {
                                            size: 8
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                    text: '线损率 (%)',
                                        font: {
                                            size: 8
                                        }
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    },
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                    }
                                }
                            }
                        }
                    });

                    // 更新子表图表标题
                document.querySelectorAll('.text-gray-600.font-medium')[1].textContent = '电网运行故障与风速关系';
                    
                    new Chart(subMeterCtx, {
                    type: 'line',
                        data: {
                        labels: chartData.labels,
                            datasets: [
                                {
                                label: '风速 (m/s)',
                                data: chartData.windSpeedData,
                                    borderColor: '#16a34a',
                                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: '短时故障事件 (次数)',
                                data: chartData.outageEventsData,
                                borderColor: '#f59e0b',
                                backgroundColor: 'transparent',
                                fill: false,
                                tension: 0.4,
                                borderDash: [5, 5],
                                yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    align: 'end',
                                    labels: {
                                        boxWidth: 10,
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        font: {
                                            size: 8
                                    }
                                        }
                                    },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                    title: {
                                        display: true,
                                    text: '风速 (m/s)',
                                        font: {
                                            size: 8
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                    }
                                },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                    title: {
                                        display: true,
                                    text: '故障事件 (次数)',
                                        font: {
                                            size: 8
                                        }
                                    },
                                grid: {
                                    drawOnChartArea: false
                                    },
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                    }
                                }
                            }
                        }
                    });
            } else if (tagTitle === '供电半径过长') {
                // 供电半径过长的图表配置
                    const chartData = {
                    labels: ['1日', '2日', '3日', '4日', '5日', '6日', '7日', '8日', '9日', '10日'],
                    voltageData: [220, 218, 217, 215, 213, 210, 208, 205, 202, 198],
                    distanceGroups: ['0-200m', '200-350m', '350-500m', '500-650m', '650-800m', '>800m'],
                    voltageByDistanceData: [98, 96, 93, 85, 76, 65]
                    };
                    
                    // 特定标签数据覆盖
                    if (tagData.details && tagData.details.mainMeterChartData) {
                        chartData.labels = tagData.details.mainMeterChartData.dates;
                    if (tagData.details.mainMeterChartData.voltageData) {
                        chartData.voltageData = tagData.details.mainMeterChartData.voltageData;
                    }
                    }
                    
                    // 更新图表标题
                document.querySelector('.text-gray-600.font-medium').textContent = '末端用户电压与标准电压对比';
                    
                    new Chart(mainMeterCtx, {
                        type: 'line',
                        data: {
                            labels: chartData.labels,
                            datasets: [
                                {
                                label: '末端用户电压 (V)',
                                data: chartData.voltageData,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: false,
                                    tension: 0.3,
                                    yAxisID: 'y'
                                },
                                {
                                label: '标准电压下限',
                                data: Array(chartData.labels.length).fill(209),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0)',
                                    fill: false,
                                    borderDash: [5, 5],
                                tension: 0,
                                yAxisID: 'y'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    align: 'end',
                                    labels: {
                                        boxWidth: 10,
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(1) + ' V';
                                            if (context.datasetIndex === 0 && context.parsed.y < 209) {
                                                label += ' (低于标准)';
                                            }
                                        }
                                        return label;
                                    }
                                }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                    text: '电压 (V)',
                                        font: {
                                            size: 8
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            size: 8
                                    }
                                },
                                min: 190,
                                max: 230
                                }
                            }
                        }
                    });

                    // 更新子表图表标题
                document.querySelectorAll('.text-gray-600.font-medium')[1].textContent = '不同供电距离的电压合格率';
                    
                    new Chart(subMeterCtx, {
                        type: 'bar',
                        data: {
                        labels: chartData.distanceGroups,
                            datasets: [
                                {
                                label: '电压合格率 (%)',
                                data: chartData.voltageByDistanceData,
                                backgroundColor: function(context) {
                                    const value = context.dataset.data[context.dataIndex];
                                    return value < 80 ? 'rgba(239, 68, 68, 0.6)' : 'rgba(22, 163, 74, 0.6)';
                                },
                                borderColor: function(context) {
                                    const value = context.dataset.data[context.dataIndex];
                                    return value < 80 ? 'rgba(239, 68, 68, 1)' : 'rgba(22, 163, 74, 1)';
                                },
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    align: 'end',
                                    labels: {
                                        boxWidth: 10,
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                tooltip: {
                                mode: 'index',
                                intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            const value = context.parsed.y;
                                            label += value.toFixed(1) + '%';
                                            if (value < 80) {
                                                label += ' (不合格)';
                                            } else {
                                                label += ' (合格)';
                                            }
                                        }
                                        return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                    text: '合格率 (%)',
                                        font: {
                                            size: 8
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            size: 8
                                        }
                                },
                                max: 100
                                }
                            }
                        }
                    });
            } else if (tagTitle === '时钟同步偏差') {
                // 时钟同步偏差特有数据
                processedData.clockDriftData = sourceData.clockDriftData || [3, 5, 12, 22, 28, 32, 25, 18, 8, 3]; // 时钟漂移误差(分钟)
                processedData.collectionRateData = sourceData.collectionRateData || [98, 97, 95, 82, 75, 68, 72, 85, 92, 95]; // 采集成功率(%)
                processedData.clockEventCountData = sourceData.clockEventCountData || [0, 0, 4, 8, 12, 15, 9, 5, 1, 0]; // 时钟相关事件数量
                processedData.asyncMetersData = sourceData.asyncMetersData || [2, 3, 8, 15, 22, 26, 18, 10, 4, 2]; // 时钟不同步电表数量
                processedData.timeShiftCategories = sourceData.timeShiftCategories || ['正常(±2分钟)', '轻微偏差(±10分钟)', '中度偏差(±20分钟)', '严重偏差(>30分钟)'];
                processedData.timeShiftDistribution = sourceData.timeShiftDistribution || [12, 8, 5, 18]; // 各时钟偏差等级的电表数量分布
                
                // 主图表配置（时钟漂移误差与采集成功率关系）
                const mainChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
                mainChartOptions.scales = {
                    x: chartUtils.defaultOptions.scales.x,
                    y: chartUtils.createYAxis('时钟漂移误差 (分钟)', 'left', { beginAtZero: true }),
                    y1: chartUtils.createYAxis('采集成功率 (%)', 'right', { min: 50, max: 100 }),
                    y2: chartUtils.createYAxis('线损率 (%)', 'right')
                };
                
                // 添加自定义工具提示回调
                mainChartOptions.plugins.tooltip = {
                    ...mainChartOptions.plugins.tooltip,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.dataset.label.includes('时钟漂移')) {
                                    label += context.parsed.y.toFixed(1) + ' 分钟';
                                    if (context.parsed.y > 10) {
                                        label += ' (异常)';
                                    }
                                } else if (context.dataset.label.includes('采集成功率')) {
                                    label += context.parsed.y.toFixed(1) + '%';
                                    if (context.parsed.y < 90) {
                                        label += ' (偏低)';
                                    }
                } else {
                                    label += context.parsed.y.toFixed(1);
                                }
                            }
                            return label;
                        }
                    }
                };
                
                // 辅图表配置（时钟偏差分布）
                const subChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
                // 移除饼图不需要的坐标轴配置
                // 饼图不需要X轴和Y轴
                delete subChartOptions.scales;
                
                // 设置饼图的特殊配置
                subChartOptions.plugins.legend = {
                    position: 'right',
                    align: 'center',
                    labels: {
                        boxWidth: 10,
                        font: { size: 9 },
                        padding: 5
                    }
                };
                
                subChartOptions.plugins.tooltip = {
                    ...subChartOptions.plugins.tooltip,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value}台 (${percentage}%)`;
                        }
                    }
                };
                
                // 主图表数据集
                const mainDatasets = [
                    chartUtils.createDataset('时钟漂移误差 (分钟)', chartData.clockDriftData, 'red', 'y', {
                        borderWidth: 2,
                        tension: 0.4
                    }),
                    chartUtils.createDataset('采集成功率 (%)', chartData.collectionRateData, 'blue', 'y1', {
                        borderWidth: 2,
                        tension: 0.4
                    }),
                    chartUtils.createDataset('线损率 (%)', chartData.lossRateData, 'green', 'y2', {
                                borderDash: [5, 5]
                    })
                ];
                
                // 子图表数据集 - 饼图数据
                const subDatasets = [{
                    data: chartData.timeShiftDistribution,
                    backgroundColor: [
                        'rgba(22, 163, 74, 0.7)',  // 绿色 - 正常
                        'rgba(251, 191, 36, 0.7)', // 黄色 - 轻微偏差
                        'rgba(249, 115, 22, 0.7)', // 橙色 - 中度偏差
                        'rgba(239, 68, 68, 0.7)'   // 红色 - 严重偏差
                    ],
                    borderColor: [
                        'rgba(22, 163, 74, 1)',
                        'rgba(251, 191, 36, 1)',
                        'rgba(249, 115, 22, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 1
                }];
                
                return {
                    mainChartTitle: '时钟偏差与采集成功率关系图',
                    subChartTitle: '电表时钟偏差分布',
                    mainChartType: 'line',
                    subChartType: 'pie',
                    mainChartData: { labels: chartData.labels, datasets: mainDatasets },
                    subChartData: { labels: chartData.timeShiftCategories, datasets: subDatasets },
                    mainChartOptions: mainChartOptions,
                    subChartOptions: subChartOptions
                };
            } else {
                // 默认低压设备故障
                probabilityHtml = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="text-left py-1 px-2 font-medium">特征</th>
                                <th class="text-center py-1 px-2 font-medium">权重</th>
                                <th class="text-right py-1 px-2 font-medium">发生概率</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-1 px-2">多户电压波动事件</td>
                                <td class="text-center py-1 px-2">35%</td>
                                <td class="text-right py-1 px-2 text-orange-600">28%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">线路接头温度异常</td>
                                <td class="text-center py-1 px-2">25%</td>
                                <td class="text-right py-1 px-2 text-orange-600">20%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">线损率突变特征</td>
                                <td class="text-center py-1 px-2">20%</td>
                                <td class="text-right py-1 px-2 text-orange-600">15%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">三相不平衡度超标</td>
                                <td class="text-center py-1 px-2">12%</td>
                                <td class="text-right py-1 px-2 text-orange-600">8%</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 px-2">设备温度传感器警告</td>
                                <td class="text-center py-1 px-2">8%</td>
                                <td class="text-right py-1 px-2 text-orange-600">4%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-medium text-base">
                                <td colspan="2" class="py-2 px-2 text-right">匹配概率</td>
                                <td class="py-2 px-2 text-right text-orange-600">75%</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            }
            
            probabilityContent.innerHTML = probabilityHtml;
            
            // 初始化图表
            setTimeout(() => {
                // 获取标签类型
                const tagType = tagData.title;
                const mainMeterCtx = document.getElementById('mainMeterTimeSeriesChart').getContext('2d');
                const subMeterCtx = document.getElementById('subMeterTimeSeriesChart').getContext('2d');
                
                // 初始化图表管理器
                initializeCharts(tagType, tagData, mainMeterCtx, subMeterCtx);
            }, 100);
        }
        
        // 图表渲染器模块 - 统一管理所有图表的渲染逻辑
        const ChartRenderer = {
            // 存储图表实例的引用，用于清理
            chartInstances: {
                main: null,
                sub: null
            },
            
            // 清理现有图表实例，防止内存泄漏
            cleanupCharts: function() {
                if (this.chartInstances.main) {
                    this.chartInstances.main.destroy();
                    this.chartInstances.main = null;
                }
                
                if (this.chartInstances.sub) {
                    this.chartInstances.sub.destroy();
                    this.chartInstances.sub = null;
                }
            },
            
            // 为指定标签渲染图表
            renderChartsForTag: function(tagData, mainCtx, subCtx) {
                // 清理现有图表
                this.cleanupCharts();
                
                // 获取标签类型
                const tagType = tagData.title;
                
                // 使用统一的图表配置生成函数
                const chartConfigs = createChartConfigByTagType(tagType, tagData);
                
                // 如果配置正确，创建图表
                if (chartConfigs) {
                    // 设置图表标题 - 使用新的选择器
                    this.setChartTitles(chartConfigs.mainChartTitle, chartConfigs.subChartTitle);
                    
                    // 创建总表图表
                    this.chartInstances.main = new Chart(mainCtx, {
                        type: chartConfigs.mainChartType || 'line',
                        data: chartConfigs.mainChartData,
                        options: chartConfigs.mainChartOptions
                    });
                    
                    // 创建子表图表
                    this.chartInstances.sub = new Chart(subCtx, {
                        type: chartConfigs.subChartType || 'line',
                        data: chartConfigs.subChartData,
                        options: chartConfigs.subChartOptions
                    });
                }
            },
            
            // 设置图表标题 - 独立方法以提高复用性
            setChartTitles: function(mainTitle, subTitle) {
                const mainTitleElement = document.querySelector('.chart-title[data-chart-id="mainMeterTimeSeriesChart"]');
                const subTitleElement = document.querySelector('.chart-title[data-chart-id="subMeterTimeSeriesChart"]');
                
                if (mainTitleElement && mainTitle) {
                    mainTitleElement.textContent = mainTitle;
                }
                
                if (subTitleElement && subTitle) {
                    subTitleElement.textContent = subTitle;
                }
            }
        };
        
        // 图表公共配置和工具函数 - 提高内聚性与复用性
        const chartUtils = {
            // 公共配置选项
            defaultOptions: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                align: 'end',
                                labels: {
                                    boxWidth: 10,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    font: {
                                        size: 8
                            }
                        }
                                    }
                                }
                            },
            
            // 创建Y轴配置
            createYAxis: function(title, position = 'left', options = {}) {
                return {
                                type: 'linear',
                                display: true,
                    position: position,
                                title: {
                                    display: true,
                        text: title,
                                    font: {
                                        size: 8
                                    }
                                },
                    grid: position === 'right' ? {
                        drawOnChartArea: false
                    } : undefined,
                                ticks: {
                                    font: {
                                        size: 8
                                    }
                    },
                    ...options
                };
            },
            
            // 创建数据集配置
            createDataset: function(label, data, color, axisID, options = {}) {
                const colors = {
                    blue: '#3b82f6',
                    red: '#ef4444',
                    green: '#16a34a',
                    orange: '#f59e0b',
                    purple: '#8b5cf6',
                    cyan: '#06b6d4',
                    yellow: '#fbbf24'
                };
                
                const borderColor = colors[color] || color;
                const backgroundColor = colors[color] ? 
                    `rgba(${this.hexToRgb(colors[color]).join(', ')}, 0.1)` : 
                    color;
                
                return {
                    label: label,
                    data: data,
                    borderColor: borderColor,
                    backgroundColor: backgroundColor,
                    fill: false,
                    tension: 0.3,
                    yAxisID: axisID,
                    ...options
                };
            },
            
            // 创建柱状图数据集，支持动态颜色
            createBarDataset: function(label, data, options = {}) {
                return {
                    label: label,
                    data: data,
                    borderWidth: 1,
                    ...options
                };
            },
            
            // 创建带有阈值判断的动态颜色配置
            createDynamicColorCallback: function(thresholdValue, normalColor = 'green', abnormalColor = 'red', isGreaterAbnormal = true) {
                const normalRgb = this.hexToRgb(this.getColorHex(normalColor));
                const abnormalRgb = this.hexToRgb(this.getColorHex(abnormalColor));
                
                return {
                    backgroundColor: function(context) {
                        const value = context.dataset.data[context.dataIndex];
                        const isAbnormal = isGreaterAbnormal ? value > thresholdValue : value < thresholdValue;
                        return isAbnormal ? 
                            `rgba(${abnormalRgb.join(', ')}, 0.6)` : 
                            `rgba(${normalRgb.join(', ')}, 0.6)`;
                    },
                    borderColor: function(context) {
                        const value = context.dataset.data[context.dataIndex];
                        const isAbnormal = isGreaterAbnormal ? value > thresholdValue : value < thresholdValue;
                        return isAbnormal ? 
                            `rgba(${abnormalRgb.join(', ')}, 1)` : 
                            `rgba(${normalRgb.join(', ')}, 1)`;
                    }
                };
            },
            
            // 创建带有阈值判断的提示回调
            createThresholdTooltipCallback: function(thresholdValue, normalText = '正常', abnormalText = '异常', isGreaterAbnormal = true, options = {}) {
                return {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                const value = context.parsed.y;
                                let formattedValue = options.valuePrefix || '';
                                formattedValue += value.toFixed(options.decimals || 1);
                                formattedValue += options.valueSuffix || '';
                                
                                label += formattedValue;
                                
                                const isAbnormal = isGreaterAbnormal ? value > thresholdValue : value < thresholdValue;
                                if (isAbnormal) {
                                    label += ` (${abnormalText})`;
                                } else {
                                    label += ` (${normalText})`;
                                }
                            }
                            return label;
                        }
                    }
                };
            },
            
            // 获取颜色Hex值
            getColorHex: function(color) {
                const colors = {
                    blue: '#3b82f6',
                    red: '#ef4444',
                    green: '#16a34a',
                    orange: '#f59e0b',
                    purple: '#8b5cf6',
                    cyan: '#06b6d4',
                    yellow: '#fbbf24'
                };
                
                return colors[color] || color;
            },
            
            // 将十六进制颜色转换为RGB数组
            hexToRgb: function(hex) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return [r, g, b];
            },
            
            // 创建堆叠图的配置
            createStackedDataset: function(label, data, color, stackGroup = 'default', options = {}) {
                return {
                    ...this.createDataset(label, data, color, null, options),
                    stack: stackGroup
                };
            },
            
            // 合并配置对象
            mergeOptions: function(baseOptions, additionalOptions) {
                return deepMerge(baseOptions, additionalOptions);
            },
            
            // 克隆配置对象 - 用于避免修改默认配置
            cloneOptions: function(options) {
                return JSON.parse(JSON.stringify(options));
            }
        };
        
        // 深度合并对象辅助函数
        function deepMerge(target, source) {
            const output = {...target};
            
            for (const key in source) {
                if (isObject(source[key]) && key in target && isObject(target[key])) {
                    output[key] = deepMerge(target[key], source[key]);
                } else {
                    output[key] = source[key];
                }
            }
            
            return output;
        }
        
        // 检查是否为对象
        function isObject(item) {
            return (item && typeof item === 'object' && !Array.isArray(item));
        }
        
        // 初始化所有图表的通用入口函数
        function initializeCharts(tagType, tagData, mainMeterCtx, subMeterCtx) {
            // 使用Chart渲染器处理图表
            ChartRenderer.renderChartsForTag(tagData, mainMeterCtx, subMeterCtx);
        }
        
        // 根据标签类型创建图表配置
        function createChartConfigByTagType(tagType, tagData) {
            // 获取标签数据
            const chartData = getProcessedChartData(tagType, tagData);
            
            // 根据标签类型返回对应的图表配置
            switch(tagType) {
                case 'CT互感器倍率错误':
                    return createCTRatioErrorChartConfig(chartData);
                case '台区户表关系错误':
                    return createMeterRelationErrorChartConfig(chartData);
                case '窃电行为突增':
                    return createElectricityTheftChartConfig(chartData);
                case '恶劣天气影响':
                    return createBadWeatherChartConfig(chartData);
                case '计量装置接线错误':
                    return createMeteringWiringErrorChartConfig(chartData);
                case '电表正反向设置错误':
                    return createMeterDirectionErrorChartConfig(chartData);
                case '供电半径过长':
                    return createLongSupplyRadiusChartConfig(chartData);
                case '时钟同步偏差':
                    return createClockSyncChartConfig(chartData);
                case '分布式能源反向计量异常':
                    return createDistributedEnergyMeteringChartConfig(chartData);
                default:
                    return createDefaultChartConfig(chartData);
            }
        }
        
        // 处理和标准化图表数据
        function getProcessedChartData(tagType, tagData) {
            // 通用数据结构
            const defaultData = {
                labels: ['1日', '2日', '3日', '4日', '5日', '6日', '7日', '8日', '9日', '10日'],
                usageData: [1485, 1510, 1498, 1522, 1540, 1502, 1485, 1650, 1720, 1835],
                lossRateData: [6.1, 6.2, 6.3, 6.1, 6.4, 6.5, 6.3, 9.8, 11.5, 12.8]
            };
            
            // 如果标签数据中有图表数据，则使用它
            if (tagData.details && tagData.details.mainMeterChartData) {
                const sourceData = tagData.details.mainMeterChartData;
                
                // 构建标准化后的数据对象
                const processedData = {
                    labels: sourceData.dates || defaultData.labels,
                    usageData: sourceData.usage || defaultData.usageData,
                    lossRateData: sourceData.lossRate || defaultData.lossRateData
                };
                
                // 根据标签类型添加额外的数据字段
                if (tagType === '计量装置接线错误') {
                    processedData.powerFactorData = sourceData.powerFactorData || [0.92, 0.91, 0.92, 0.65, 0.62, 0.58, 0.55, 0.53, 0.52, 0.50];
                    processedData.phaseAngleData = sourceData.phaseAngleData || [1.5, 1.8, 1.7, 105.0, 112.5, 118.2, 122.5, 124.1, 125.8, 126.5]; 
                    processedData.phaseUnbalanceData = sourceData.phaseUnbalanceData || [2.5, 2.8, 2.7, 8.5, 9.2, 9.8, 10.3, 10.8, 11.2, 11.5];
                } else if (tagType === '低压设备故障') {
                    processedData.powerFactorData = sourceData.powerFactorData || [0.92, 0.91, 0.90, 0.87, 0.85, 0.83, 0.82, 0.81, 0.80, 0.79];
                    processedData.harmonicContentData = sourceData.harmonicContentData || [2.1, 2.2, 2.5, 3.2, 3.8, 4.3, 4.8, 5.2, 5.5, 5.8];
                    processedData.equipmentTempData = sourceData.equipmentTempData || [28, 30, 35, 42, 48, 55, 62, 68, 72, 76];
                    processedData.phaseImbalanceData = sourceData.phaseImbalanceData || [1.2, 1.5, 2.0, 2.8, 3.5, 4.2, 5.0, 5.8, 6.5, 7.2];
                } else if (tagType === '窃电行为突增') {
                    processedData.meterEventsData = sourceData.meterEventsData || [2, 3, 5, 8, 10, 12, 15, 14, 16, 18];
                    processedData.dayTimeRatio = sourceData.dayTimeRatio || [0.72, 0.71, 0.69, 0.65, 0.62, 0.58, 0.55, 0.54, 0.52, 0.50];
                    processedData.nightTimeRatio = sourceData.nightTimeRatio || [0.28, 0.29, 0.31, 0.35, 0.38, 0.42, 0.45, 0.46, 0.48, 0.50];
                    processedData.abnormalUsersCount = sourceData.abnormalUsersCount || [2, 3, 5, 8, 12, 15, 18, 20, 22, 25];
                    processedData.magneticFieldEvents = sourceData.magneticFieldEvents || [0, 1, 2, 3, 5, 6, 7, 8, 9, 10];
                } else if (tagType === '恶劣天气影响') {
                    processedData.rainfallData = sourceData.rainfall || [0, 2, 38, 65, 43, 15, 5, 0, 0, 0];
                    processedData.windSpeedData = sourceData.windSpeed || [3.2, 5.8, 12.5, 15.2, 13.6, 8.2, 4.5, 3.6, 3.2, 3.0];
                    processedData.outageEventsData = sourceData.outageEvents || [0, 1, 12, 18, 9, 5, 2, 0, 0, 0];
                } else if (tagType === '供电半径过长') {
                    processedData.voltageData = sourceData.voltageData || [220, 218, 217, 215, 213, 210, 208, 205, 202, 198];
                    processedData.distanceGroups = sourceData.distanceGroups || ['0-200m', '200-350m', '350-500m', '500-650m', '650-800m', '>800m'];
                    processedData.voltageByDistanceData = sourceData.voltageByDistanceData || [98, 96, 93, 85, 76, 65];
                } else if (tagType === '时钟同步偏差') {
                    // 时钟同步偏差特有数据
                    processedData.clockDriftData = sourceData.clockDriftData || [3, 5, 12, 22, 28, 32, 25, 18, 8, 3]; // 时钟漂移误差(分钟)
                    processedData.collectionRateData = sourceData.collectionRateData || [98, 97, 95, 82, 75, 68, 72, 85, 92, 95]; // 采集成功率(%)
                    processedData.clockEventCountData = sourceData.clockEventCountData || [0, 0, 4, 8, 12, 15, 9, 5, 1, 0]; // 时钟相关事件数量
                    processedData.asyncMetersData = sourceData.asyncMetersData || [2, 3, 8, 15, 22, 26, 18, 10, 4, 2]; // 时钟不同步电表数量
                    processedData.timeShiftCategories = sourceData.timeShiftCategories || ['正常(±2分钟)', '轻微偏差(±10分钟)', '中度偏差(±20分钟)', '严重偏差(>30分钟)'];
                    processedData.timeShiftDistribution = sourceData.timeShiftDistribution || [12, 8, 5, 18]; // 各时钟偏差等级的电表数量分布
                } else if (tagType === '分布式能源反向计量异常') {
                    // 分布式能源反向计量异常特有数据
                    processedData.importACumulativeData = sourceData.importACumulative || [1600, 1630, 1650, 1700, 1750, 1780, 1820, 1850, 1880, 1900]; // 日正向有功累计用电量
                    processedData.exportACumulativeData = sourceData.exportACumulative || [120, 125, 170, 260, 340, 390, 450, 520, 580, 630]; // 日反向有功累计用电量（光伏发电量）
                    processedData.solarIrradianceData = sourceData.solarIrradiance || [55, 58, 75, 82, 85, 86, 87, 88, 86, 85]; // 模拟光照强度数据 (%)
                    processedData.temperatureData = sourceData.temperature || [12, 13, 15, 16, 18, 19, 20, 21, 20, 19]; // 模拟温度数据
                    processedData.actualExportData = sourceData.actualExport || [120, 125, 170, 500, 520, 580, 610, 670, 710, 720]; // 理论预期的反向电能
                    processedData.exportRatioData = sourceData.exportRatio || [1.0, 1.0, 1.0, 0.52, 0.65, 0.67, 0.74, 0.78, 0.82, 0.88]; // 比例：实际反向电能/预期反向电能
                    processedData.eventCountData = sourceData.eventCount || [0, 0, 1, 3, 4, 2, 2, 1, 1, 0]; // 相关电表事件统计
                }
                
                return processedData;
            }
            
            return defaultData;
        }
        
        // 计量装置接线错误图表配置生成器
        function createMeteringWiringErrorChartConfig(chartData) {
            // 主图表配置（功率因数与相位角异常检测）
            const mainChartOptions = JSON.parse(JSON.stringify(chartUtils.defaultOptions));
            mainChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('功率因数', 'left', { min: 0, max: 1 }),
                y1: chartUtils.createYAxis('相位角 (°)', 'right'),
                y2: chartUtils.createYAxis('线损率 (%)', 'right')
            };
            
            // 辅图表配置（三相不平衡度变化）
            const subChartOptions = JSON.parse(JSON.stringify(chartUtils.defaultOptions));
            subChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('不平衡度 (%)', 'left', { beginAtZero: true })
            };
            
            // 添加自定义工具提示回调
            subChartOptions.plugins.tooltip.callbacks = {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                        label += ': ';
                    }
                    if (context.parsed.y !== null) {
                        const value = context.parsed.y;
                        label += value.toFixed(1) + '%';
                        if (value > 5) {
                            label += ' (异常)';
                        } else {
                            label += ' (正常)';
                        }
                    }
                    return label;
                }
            };
            
            // 主图表数据集
            const mainDatasets = [
                chartUtils.createDataset('功率因数', chartData.powerFactorData, 'blue', 'y'),
                chartUtils.createDataset('相位角 (°)', chartData.phaseAngleData, 'red', 'y1'),
                chartUtils.createDataset('线损率 (%)', chartData.lossRateData, 'green', 'y2', { borderDash: [5, 5] })
            ];
            
            // 子图表数据集（带有动态颜色的柱状图）
            const subDatasets = [{
                label: '三相不平衡度 (%)',
                data: chartData.phaseUnbalanceData,
                backgroundColor: function(context) {
                    const value = context.dataset.data[context.dataIndex];
                    return value > 5 ? 'rgba(239, 68, 68, 0.6)' : 'rgba(22, 163, 74, 0.6)';
                },
                borderColor: function(context) {
                    const value = context.dataset.data[context.dataIndex];
                    return value > 5 ? 'rgba(239, 68, 68, 1)' : 'rgba(22, 163, 74, 1)';
                },
                borderWidth: 1
            }];
            
            return {
                mainChartTitle: '功率因数与相位角异常检测',
                subChartTitle: '三相不平衡度变化',
                mainChartType: 'line',
                subChartType: 'bar',
                mainChartData: { labels: chartData.labels, datasets: mainDatasets },
                subChartData: { labels: chartData.labels, datasets: subDatasets },
                mainChartOptions: mainChartOptions,
                subChartOptions: subChartOptions
            };
        }
        
        // 低压设备故障图表配置生成器
        function createEquipmentFailureChartConfig(chartData) {
            // 主图表配置（设备温度与故障诊断分析）
            const mainChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
            mainChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('温度 (°C)', 'left', { min: 20, max: 80 }),
                y1: chartUtils.createYAxis('线损率 (%)', 'right')
            };
            
            // 添加自定义工具提示回调
            mainChartOptions.plugins.tooltip = {
                ...mainChartOptions.plugins.tooltip,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            if (context.dataset.label.includes('温度')) {
                                label += context.parsed.y.toFixed(1) + ' °C';
                                // 温度超过45℃开始异常
                                if (context.parsed.y > 45) {
                                    label += ' (异常)';
                                    if (context.parsed.y > 60) {
                                        label += ' - 过热风险!';
                                    }
                                } else {
                                    label += ' (正常)';
                                }
                            } else if (context.dataset.label.includes('线损率')) {
                                label += context.parsed.y.toFixed(1) + '%';
                                if (context.parsed.y > 8) {
                                    label += ' (偏高)';
                                } else {
                                    label += ' (正常)';
                                }
                            } else {
                                label += context.parsed.y.toFixed(1);
                            }
                        }
                        return label;
                    }
                }
            };
            
            // 添加设备过热标准线和异常区域
            mainChartOptions.plugins.annotation = {
                annotations: {
                    normalTempLine: {
                        type: 'line',
                        yMin: 35,
                        yMax: 35,
                        borderColor: 'rgba(22, 163, 74, 0.5)', // 绿色
                        borderWidth: 1,
                        borderDash: [2, 2],
                        label: {
                            content: '正常温度上限',
                            enabled: true,
                            position: 'start',
                            backgroundColor: 'rgba(22, 163, 74, 0.7)',
                            font: { size: 8 }
                        }
                    },
                    warningTempLine: {
                        type: 'line',
                        yMin: 45,
                        yMax: 45,
                        borderColor: 'rgba(245, 158, 11, 0.5)', // 橙色
                        borderWidth: 1,
                        borderDash: [2, 2],
                        label: {
                            content: '警告温度',
                            enabled: true,
                            position: 'start',
                            backgroundColor: 'rgba(245, 158, 11, 0.7)',
                            font: { size: 8 }
                        }
                    },
                    dangerTempLine: {
                        type: 'line',
                        yMin: 60,
                        yMax: 60,
                        borderColor: 'rgba(239, 68, 68, 0.5)', // 红色
                        borderWidth: 1,
                        borderDash: [2, 2],
                        label: {
                            content: '危险温度',
                            enabled: true,
                            position: 'start',
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            font: { size: 8 }
                        }
                    },
                    dangerArea: {
                        type: 'box',
                        xMin: 2, // 从第3天开始异常
                        yMin: 45,
                        yMax: 80,
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderColor: 'rgba(239, 68, 68, 0)',
                    }
                }
            };
            
            // 辅图表配置（电能质量分析）
            const subChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
            subChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('谐波含量 (%)', 'left', { min: 0, max: 8 }),
                y1: chartUtils.createYAxis('三相不平衡度 (%)', 'right', { min: 0, max: 10 })
            };
            
            // 添加自定义工具提示回调
            subChartOptions.plugins.tooltip = {
                ...subChartOptions.plugins.tooltip,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            const value = context.parsed.y;
                            label += value.toFixed(1) + '%';
                            
                            if (context.dataset.label.includes('谐波')) {
                                if (value > 3) {
                                    label += ' (超标)';
                                } else {
                                    label += ' (正常)';
                                }
                            } else if (context.dataset.label.includes('不平衡')) {
                                if (value > 5) {
                                    label += ' (超标)';
                                } else {
                                    label += ' (正常)';
                                }
                            }
                        }
                        return label;
                    }
                }
            };
            
            // 添加谐波和三相不平衡度标准线
            subChartOptions.plugins.annotation = {
                annotations: {
                    harmonicStandardLine: {
                        type: 'line',
                        yMin: 3,
                        yMax: 3,
                        borderColor: 'rgba(59, 130, 246, 0.5)', // 蓝色
                        borderWidth: 1,
                        borderDash: [2, 2],
                        yScaleID: 'y',
                        label: {
                            content: '谐波含量标准限值',
                            enabled: true,
                            position: 'start',
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            font: { size: 8 }
                        }
                    },
                    unbalanceStandardLine: {
                        type: 'line',
                        yMin: 5,
                        yMax: 5,
                        borderColor: 'rgba(249, 115, 22, 0.5)', // 橙色
                        borderWidth: 1,
                        borderDash: [2, 2],
                        yScaleID: 'y1',
                        label: {
                            content: '不平衡度标准限值',
                            enabled: true,
                            position: 'end',
                            backgroundColor: 'rgba(249, 115, 22, 0.7)',
                            font: { size: 8 }
                        }
                    }
                }
            };
            
            // 主图表数据集
            const mainDatasets = [
                {
                    label: '设备温度 (°C)',
                    data: chartData.equipmentTempData,
                    borderColor: '#ef4444', // 红色
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.3,
                    yAxisID: 'y'
                },
                {
                    label: '线损率 (%)',
                    data: chartData.lossRateData,
                    borderColor: '#16a34a', // 绿色
                    backgroundColor: 'rgba(22, 163, 74, 0.1)',
                    fill: false,
                    tension: 0.3,
                    borderDash: [5, 5],
                    yAxisID: 'y1'
                }
            ];
            
            // 子图表数据集
            const subDatasets = [
                {
                    label: '谐波含量 (%)',
                    data: chartData.harmonicContentData,
                    borderColor: '#3b82f6', // 蓝色
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: false,
                    tension: 0.3,
                    yAxisID: 'y'
                },
                {
                    label: '三相不平衡度 (%)',
                    data: chartData.phaseImbalanceData,
                    borderColor: '#f59e0b', // 黄色
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    fill: false,
                    tension: 0.3,
                    borderDash: [3, 3],
                    yAxisID: 'y1'
                }
            ];
            
            return {
                mainChartTitle: '设备温度与线损率关系',
                subChartTitle: '电能质量分析',
                mainChartType: 'line',
                subChartType: 'line',
                mainChartData: { labels: chartData.labels, datasets: mainDatasets },
                subChartData: { labels: chartData.labels, datasets: subDatasets },
                mainChartOptions: mainChartOptions,
                subChartOptions: subChartOptions
            };
        }
        
        // 窃电行为突增图表配置生成器
        function createElectricityTheftChartConfig(chartData) {
            // 主图表配置（电表异常事件与线损率关系）
            const mainChartOptions = JSON.parse(JSON.stringify(chartUtils.defaultOptions));
            mainChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('事件数量', 'left', { beginAtZero: true }),
                y1: chartUtils.createYAxis('线损率 (%)', 'right')
            };
            
            // 辅图表配置（日间/夜间用电比例变化）
            const subChartOptions = JSON.parse(JSON.stringify(chartUtils.defaultOptions));
            subChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('用电比例', 'left', { 
                    min: 0, 
                    max: 1,
                    stacked: true,
                    ticks: {
                        font: { size: 8 },
                        callback: function(value) {
                            return Math.round(value * 100) + '%';
                        }
                    }
                }),
                y1: chartUtils.createYAxis('异常用户数', 'right', { beginAtZero: true })
            };
            
            // 主图表数据集
            const mainDatasets = [
                chartUtils.createDataset('电表异常事件数量', chartData.meterEventsData, 'blue', 'y'),
                chartUtils.createDataset('磁场干扰事件数量', chartData.magneticFieldEvents, 'purple', 'y', { borderDash: [5, 5] }),
                chartUtils.createDataset('线损率 (%)', chartData.lossRateData, 'red', 'y1')
            ];
            
            // 子图表数据集（堆叠柱状图和折线图组合）
            const subDatasets = [
                {
                    label: '日间用电比例',
                    data: chartData.dayTimeRatio,
                    backgroundColor: 'rgba(251, 191, 36, 0.6)',
                    borderColor: 'rgba(251, 191, 36, 1)',
                    borderWidth: 1,
                    stack: 'Stack 0'
                },
                {
                    label: '夜间用电比例',
                    data: chartData.nightTimeRatio,
                    backgroundColor: 'rgba(29, 78, 216, 0.6)',
                    borderColor: 'rgba(29, 78, 216, 1)',
                    borderWidth: 1,
                    stack: 'Stack 0'
                },
                {
                    label: '异常用户数量',
                    data: chartData.abnormalUsersCount,
                    type: 'line',
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.3,
                    yAxisID: 'y1'
                }
            ];
            
            return {
                mainChartTitle: '电表异常事件与线损率关系',
                subChartTitle: '日间/夜间用电比例变化',
                mainChartType: 'line',
                subChartType: 'bar',
                mainChartData: { labels: chartData.labels, datasets: mainDatasets },
                subChartData: { labels: chartData.labels, datasets: subDatasets },
                mainChartOptions: mainChartOptions,
                subChartOptions: subChartOptions
            };
        }
        
        // 恶劣天气影响图表配置生成器
        function createBadWeatherChartConfig(chartData) {
            // 主图表配置（气象数据与电网运行状况相关性）
            const mainChartOptions = JSON.parse(JSON.stringify(chartUtils.defaultOptions));
            mainChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('降雨量 (mm)', 'left'),
                y1: chartUtils.createYAxis('线损率 (%)', 'right')
            };
            
            // 辅图表配置（电网运行故障与风速关系）
            const subChartOptions = JSON.parse(JSON.stringify(chartUtils.defaultOptions));
            subChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('风速 (m/s)', 'left'),
                y1: chartUtils.createYAxis('故障事件 (次数)', 'right')
            };
            
            // 主图表数据集
            const mainDatasets = [
                {
                    label: '日降雨量 (mm)',
                    data: chartData.rainfallData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y'
                },
                chartUtils.createDataset('线损率 (%)', chartData.lossRateData, 'red', 'y1', { tension: 0.4 })
            ];
            
            // 子图表数据集
            const subDatasets = [
                {
                    label: '风速 (m/s)',
                    data: chartData.windSpeedData,
                                borderColor: '#16a34a',
                                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                fill: true,
                    tension: 0.4,
                    yAxisID: 'y'
                            },
                            {
                    label: '短时故障事件 (次数)',
                    data: chartData.outageEventsData,
                                borderColor: '#f59e0b',
                                backgroundColor: 'transparent',
                                fill: false,
                    tension: 0.4,
                    borderDash: [5, 5],
                    yAxisID: 'y1'
                }
            ];
            
            return {
                mainChartTitle: '气象数据与电网运行状况相关性',
                subChartTitle: '电网运行故障与风速关系',
                mainChartType: 'line',
                subChartType: 'line',
                mainChartData: { labels: chartData.labels, datasets: mainDatasets },
                subChartData: { labels: chartData.labels, datasets: subDatasets },
                mainChartOptions: mainChartOptions,
                subChartOptions: subChartOptions
            };
        }
        
        // CT互感器倍率错误图表配置生成器
        function createCTRatioErrorChartConfig(chartData) {
            // 主图表配置（线损率与变比变更关系）
            const mainChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
            mainChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('电量 (kWh)', 'left'),
                y1: chartUtils.createYAxis('线损率 (%)', 'right')
            };
            
            // 添加自定义工具提示回调
            mainChartOptions.plugins.tooltip = {
                ...mainChartOptions.plugins.tooltip,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            if (context.dataset.label.includes('电量')) {
                                label += context.parsed.y.toFixed(0) + ' kWh';
                                if (context.dataIndex >= 3) {
                                    label += ' (倍率错误)';
                                }
                            } else if (context.dataset.label.includes('线损率')) {
                                label += context.parsed.y.toFixed(1) + '%';
                                if (context.parsed.y > 8) {
                                    label += ' (异常)';
                                } else {
                                    label += ' (正常)';
                                }
                            } else {
                                label += context.parsed.y.toFixed(1);
                            }
                        }
                        return label;
                    }
                }
            };
            
            // 辅图表配置（子表与总表电量对比）
            const subChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
            subChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('预期比例', 'left', { min: 0, max: 1.2 })
            };
            
            // 添加自定义工具提示回调
            subChartOptions.plugins.tooltip = {
                ...subChartOptions.plugins.tooltip,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            const value = context.parsed.y;
                            label += value.toFixed(2);
                            if (context.dataIndex >= 3) {
                                if (value < 0.6) {
                                    label += ' (总表记录偏低)';
                                }
                            }
                        }
                        return label;
                    }
                }
            };
            
            // 计算预期比例 - 模拟CT变更前后的比例变化
            const expectedRatio = chartData.labels.map((label, index) => {
                // 在变更日期前，比例接近1（正常情况）
                if (index < 3) return 0.95;
                // 变更后，比例降低至0.5左右（显示CT错误的情况）
                return 0.5;
            });
            
            // 计算实际比例 - 总表用电量与实际用电量的比值
            const actualRatio = chartData.labels.map((label, index) => {
                // 模拟一些轻微波动
                const fluctuation = (Math.random() * 0.05) - 0.025;
                if (index < 3) return 0.95 + fluctuation;
                return 0.48 + fluctuation;
            });
            
            // 创建一个标记变更日期的区域
            const ctChangeAnnotation = {
                type: 'line',
                mode: 'vertical',
                scaleID: 'x',
                value: 2.5,
                borderColor: 'rgba(255, 99, 132, 0.5)',
                borderWidth: 2,
                label: {
                    content: 'CT倍率变更',
                    enabled: true,
                                position: 'top',
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                    font: {
                                        size: 10
                                    }
                                }
            };
            
            // 添加标注
            mainChartOptions.plugins.annotation = {
                annotations: {
                    ctChangeAnnotation
                }
            };
            
            subChartOptions.plugins.annotation = {
                annotations: {
                    ctChangeAnnotation
                }
            };
            
            // 添加标准线
            const standardRatioLine = {
                type: 'line',
                mode: 'horizontal',
                scaleID: 'y',
                value: 1.0,
                borderColor: 'rgba(54, 162, 235, 0.5)',
                borderWidth: 2,
                borderDash: [5, 5],
                label: {
                    content: '标准比例 (1:1)',
                    enabled: true,
                    position: 'right',
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                    font: {
                        size: 10
                    }
                }
            };
            
            subChartOptions.plugins.annotation.annotations.standardRatioLine = standardRatioLine;
            
            // 主图表数据集
            const mainDatasets = [
                chartUtils.createDataset('日用电量 (kWh)', chartData.usageData, 'blue', 'y'),
                chartUtils.createDataset('线损率 (%)', chartData.lossRateData, 'red', 'y1', { borderDash: [5, 5] })
            ];
            
            // 子图表数据集
            const subDatasets = [
                {
                    label: '总表/子表电量比例',
                    data: actualRatio,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false
                },
                {
                    label: '预期比例',
                    data: expectedRatio,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    tension: 0.1,
                    fill: false
                }
            ];
            
            return {
                mainChartTitle: 'CT倍率变更与线损率异常关系',
                subChartTitle: '总表与子表电量比例分析',
                mainChartType: 'line',
                subChartType: 'line',
                mainChartData: { labels: chartData.labels, datasets: mainDatasets },
                subChartData: { labels: chartData.labels, datasets: subDatasets },
                mainChartOptions: mainChartOptions,
                subChartOptions: subChartOptions
            };
        }
        
        // 台区户表关系错误图表配置生成器
        function createMeterRelationErrorChartConfig(chartData) {
            // 创建图表配置...（略，可以根据已有方式实现）
            return createDefaultChartConfig(chartData, '电压相关性日维度变化', '用户用电负荷对比');
        }
        
        // 供电半径过长图表配置生成器
        function createLongSupplyRadiusChartConfig(chartData) {
            // 主图表配置（末端用户电压与标准电压对比）
            const mainChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
            mainChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('电压 (V)', 'left', { min: 190, max: 230 })
            };
            
            // 添加自定义工具提示回调
            mainChartOptions.plugins.tooltip.callbacks = {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                        label += ': ';
                    }
                    if (context.parsed.y !== null) {
                        label += context.parsed.y.toFixed(1) + ' V';
                        if (context.datasetIndex === 0 && context.parsed.y < 209) {
                            label += ' (低于标准)';
                        }
                    }
                    return label;
                }
            };
            
            // 辅图表配置（不同供电距离的电压合格率）
            const subChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
            subChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('电压合格率 (%)', 'left', { min: 0, max: 100 })
            };
            
            // 添加自定义工具提示回调
            subChartOptions.plugins.tooltip.callbacks = {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                        label += ': ';
                    }
                    if (context.parsed.y !== null) {
                        const value = context.parsed.y;
                        label += value.toFixed(1) + '%';
                        if (value < 80) {
                            label += ' (不合格)';
                        } else {
                            label += ' (合格)';
                        }
                    }
                    return label;
                }
            };
            
            // 主图表数据集
            const mainDatasets = [
                chartUtils.createDataset('末端用户电压 (V)', chartData.voltageData, 'blue', 'y'),
                chartUtils.createDataset('标准电压下限', Array(chartData.labels.length).fill(209), 'red', 'y', {
                    borderDash: [5, 5],
                    tension: 0,
                    backgroundColor: 'rgba(239, 68, 68, 0)'
                })
            ];
            
            // 子图表数据集（带有动态颜色的柱状图）
            const colorCallback = chartUtils.createDynamicColorCallback(80, 'green', 'red', false);
            const subDatasets = [
                chartUtils.createBarDataset('电压合格率 (%)', chartData.voltageByDistanceData, {
                    backgroundColor: colorCallback.backgroundColor,
                    borderColor: colorCallback.borderColor
                })
            ];
            
            return {
                mainChartTitle: '末端用户电压与标准电压对比',
                subChartTitle: '不同供电距离的电压合格率',
                mainChartType: 'line',
                subChartType: 'bar',
                mainChartData: { labels: chartData.labels, datasets: mainDatasets },
                subChartData: { labels: chartData.distanceGroups, datasets: subDatasets },
                mainChartOptions: mainChartOptions,
                subChartOptions: subChartOptions
            };
        }
        
        // 电表正反向设置错误图表配置生成器
        function createMeterDirectionErrorChartConfig(chartData) {
            // 创建图表配置...（略，可以根据已有方式实现）
            return createDefaultChartConfig(chartData, '电能计量方向异常', '用户用电异常检测');
        }
        
        // 默认图表配置生成器
        function createDefaultChartConfig(chartData, mainTitle = '电量/线损率日维度变化', subTitle = '用户用电负荷日维度变化') {
            // 主图表配置
            const mainChartOptions = JSON.parse(JSON.stringify(chartUtils.defaultOptions));
            mainChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('电量 (kWh)', 'left'),
                y1: chartUtils.createYAxis('线损率 (%)', 'right')
            };
            
            // 辅图表配置
            const subChartOptions = JSON.parse(JSON.stringify(chartUtils.defaultOptions));
            subChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('负荷 (kW/户)', 'left', { beginAtZero: false })
            };
            
            // 主图表数据集
            const mainDatasets = [
                chartUtils.createDataset('日用电量 (kWh)', chartData.usageData, 'blue', 'y'),
                chartUtils.createDataset('线损率 (%)', chartData.lossRateData, 'red', 'y1', { borderDash: [5, 5] })
            ];
            
            // 子图表数据集
            const subDatasets = [
                chartUtils.createDataset('平均日负荷 (kW/户)', [1.2, 1.25, 1.23, 1.27, 1.3, 1.26, 1.22, 1.35, 1.42, 1.5], 'green', 'y', { fill: true }),
                chartUtils.createDataset('最大日负荷 (kW/户)', [2.3, 2.4, 2.2, 2.5, 2.6, 2.4, 2.3, 2.8, 3.2, 3.5], 'orange', 'y', { borderDash: [5, 5], fill: false })
            ];
            
            return {
                mainChartTitle: mainTitle,
                subChartTitle: subTitle,
                mainChartType: 'line',
                subChartType: 'line',
                mainChartData: { labels: chartData.labels, datasets: mainDatasets },
                subChartData: { labels: chartData.labels, datasets: subDatasets },
                mainChartOptions: mainChartOptions,
                subChartOptions: subChartOptions
            };
        }
        
        // 时钟同步偏差图表配置生成器
        function createClockSyncChartConfig(chartData) {
            // 主图表配置（时钟漂移误差与采集成功率关系）
            const mainChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
            mainChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('时钟漂移误差 (分钟)', 'left', { beginAtZero: true }),
                y1: chartUtils.createYAxis('采集成功率 (%)', 'right', { min: 50, max: 100 }),
                y2: chartUtils.createYAxis('线损率 (%)', 'right')
            };
            
            // 添加自定义工具提示回调
            mainChartOptions.plugins.tooltip = {
                ...mainChartOptions.plugins.tooltip,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            if (context.dataset.label.includes('时钟漂移')) {
                                label += context.parsed.y.toFixed(1) + ' 分钟';
                                if (context.parsed.y > 10) {
                                    label += ' (异常)';
                                }
                            } else if (context.dataset.label.includes('采集成功率')) {
                                label += context.parsed.y.toFixed(1) + '%';
                                if (context.parsed.y < 90) {
                                    label += ' (偏低)';
                                }
                            } else {
                                label += context.parsed.y.toFixed(1);
                            }
                        }
                        return label;
                    }
                }
            };
            
            // 辅图表配置（时钟偏差分布）
            const subChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
            // 移除饼图不需要的坐标轴配置
            // 饼图不需要X轴和Y轴
            delete subChartOptions.scales;
            
            // 设置饼图的特殊配置
            subChartOptions.plugins.legend = {
                position: 'right',
                align: 'center',
                labels: {
                    boxWidth: 10,
                    font: { size: 9 },
                    padding: 5
                }
            };
            
            subChartOptions.plugins.tooltip = {
                ...subChartOptions.plugins.tooltip,
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.raw;
                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value}台 (${percentage}%)`;
                    }
                }
            };
            
            // 主图表数据集
            const mainDatasets = [
                chartUtils.createDataset('时钟漂移误差 (分钟)', chartData.clockDriftData, 'red', 'y', {
                    borderWidth: 2,
                    tension: 0.4
                }),
                chartUtils.createDataset('采集成功率 (%)', chartData.collectionRateData, 'blue', 'y1', {
                    borderWidth: 2,
                    tension: 0.4
                }),
                chartUtils.createDataset('线损率 (%)', chartData.lossRateData, 'green', 'y2', {
                    borderDash: [5, 5]
                })
            ];
            
            // 子图表数据集 - 饼图数据
            const subDatasets = [{
                data: chartData.timeShiftDistribution,
                backgroundColor: [
                    'rgba(22, 163, 74, 0.7)',  // 绿色 - 正常
                    'rgba(251, 191, 36, 0.7)', // 黄色 - 轻微偏差
                    'rgba(249, 115, 22, 0.7)', // 橙色 - 中度偏差
                    'rgba(239, 68, 68, 0.7)'   // 红色 - 严重偏差
                ],
                borderColor: [
                    'rgba(22, 163, 74, 1)',
                    'rgba(251, 191, 36, 1)',
                    'rgba(249, 115, 22, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 1
            }];
            
            return {
                mainChartTitle: '时钟偏差与采集成功率关系图',
                subChartTitle: '电表时钟偏差分布',
                mainChartType: 'line',
                subChartType: 'pie',
                mainChartData: { labels: chartData.labels, datasets: mainDatasets },
                subChartData: { labels: chartData.timeShiftCategories, datasets: subDatasets },
                mainChartOptions: mainChartOptions,
                subChartOptions: subChartOptions
            };
        }
        
        // 分布式能源反向计量异常图表配置生成器
        function createDistributedEnergyMeteringChartConfig(chartData) {
            // 主图表配置（光伏发电与反向电能计量对比）
            const mainChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
            mainChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('电能 (kWh)', 'left'),
                y1: chartUtils.createYAxis('百分比 (%)', 'right')
            };
            
            // 添加自定义工具提示回调
            mainChartOptions.plugins.tooltip = {
                ...mainChartOptions.plugins.tooltip,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            if (context.dataset.yAxisID === 'y') {
                                label += context.parsed.y.toFixed(0) + ' kWh';
                                
                                // 对比反向电能计量值与实际值，显示差异
                                if (context.dataset.label.includes('测得反向电能') && 
                                    context.dataIndex >= 3) { // 从第4天开始有异常
                                    const measuredValue = chartData.exportACumulativeData[context.dataIndex];
                                    const actualValue = chartData.actualExportData[context.dataIndex];
                                    const difference = Math.abs(actualValue - measuredValue);
                                    
                                    if (actualValue > measuredValue) {
                                        label += ` (少计 ${difference.toFixed(0)} kWh)`;
                                    }
                                }
                            } else if (context.dataset.label.includes('线损率')) {
                                label += context.parsed.y.toFixed(1) + '%';
                                if (context.parsed.y > 10) {
                                    label += ' (偏高)';
                                } else {
                                    label += ' (正常)';
                                }
                            } else {
                                label += context.parsed.y.toFixed(1) + '%';
                            }
                        }
                        return label;
                    }
                }
            };
            
            // 添加线损率预警线
            mainChartOptions.plugins.annotation = {
                annotations: {
                    line1: {
                        type: 'line',
                        yMin: 10,
                        yMax: 10,
                        borderColor: 'rgba(239, 68, 68, 0.5)',
                        borderWidth: 1,
                        borderDash: [2, 2],
                        yScaleID: 'y1',
                        label: {
                            content: '线损预警线',
                            enabled: true,
                            position: 'start',
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            font: {
                                size: 8
                            }
                        }
                    },
                    anomalyRegion: {
                        type: 'box',
                        xMin: 3, // 从第4天开始异常
                        xMax: 9, // 到第10天
                        yMin: 0,
                        yMax: 200, // 足够高的值来覆盖图表
                        backgroundColor: 'rgba(239, 68, 68, 0.05)',
                        borderColor: 'rgba(239, 68, 68, 0.2)',
                        borderWidth: 1,
                        label: {
                            content: '反向计量异常期间',
                            enabled: true,
                            position: 'start',
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            font: {
                                size: 8
                            }
                        }
                    }
                }
            };
            
            // 辅图表配置（反向电能计量比率）
            const subChartOptions = chartUtils.cloneOptions(chartUtils.defaultOptions);
            subChartOptions.scales = {
                x: chartUtils.defaultOptions.scales.x,
                y: chartUtils.createYAxis('反向电能比率', 'left', {
                    min: 0,
                    max: 1.1,
                    ticks: {
                        callback: function(value) {
                            return (value * 100) + '%';
                        }
                    }
                }),
                y1: chartUtils.createYAxis('事件数量', 'right', {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                })
            };
            
            // 添加自定义工具提示回调
            subChartOptions.plugins.tooltip = {
                ...subChartOptions.plugins.tooltip,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            if (context.dataset.yAxisID === 'y') {
                                const ratio = context.parsed.y;
                                label += (ratio * 100).toFixed(0) + '%';
                                
                                // 添加状态指示
                                if (ratio < 0.5) {
                                    label += ' (严重异常)';
                                } else if (ratio < 0.8) {
                                    label += ' (轻微异常)';
                                } else {
                                    label += ' (正常)';
                                }
                            } else {
                                label += context.parsed.y + ' 次';
                            }
                        }
                        return label;
                    }
                }
            };
            
            // 添加阈值标注线
            subChartOptions.plugins.annotation = {
                annotations: {
                    normalLine: {
                        type: 'line',
                        yMin: 0.8,
                        yMax: 0.8,
                        borderColor: 'rgba(22, 163, 74, 0.5)', // 绿色
                        borderWidth: 1,
                        borderDash: [2, 2],
                        yScaleID: 'y',
                        label: {
                            content: '正常阈值',
                            enabled: true,
                            position: 'start',
                            backgroundColor: 'rgba(22, 163, 74, 0.7)',
                            font: {
                                size: 8
                            }
                        }
                    },
                    warningLine: {
                        type: 'line',
                        yMin: 0.5,
                        yMax: 0.5,
                        borderColor: 'rgba(239, 68, 68, 0.5)', // 红色
                        borderWidth: 1,
                        borderDash: [2, 2],
                        yScaleID: 'y',
                        label: {
                            content: '异常阈值',
                            enabled: true,
                            position: 'end',
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            font: {
                                size: 8
                            }
                        }
                    }
                }
            };
            
            // 主图表数据集
            const mainDatasets = [
                {
                    label: '光伏实际发电量 (kWh)',
                    data: chartData.actualExportData,
                    borderColor: '#059669', // 深绿色
                    backgroundColor: 'rgba(5, 150, 105, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    yAxisID: 'y'
                },
                {
                    label: '测得反向电能 (kWh)',
                    data: chartData.exportACumulativeData,
                    borderColor: '#3b82f6', // 蓝色
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    yAxisID: 'y'
                },
                {
                    label: '光照强度 (%)',
                    data: chartData.solarIrradianceData,
                    borderColor: '#f59e0b', // 黄色
                    backgroundColor: 'transparent',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3,
                    yAxisID: 'y1'
                },
                {
                    label: '线损率 (%)',
                    data: chartData.lossRateData,
                    borderColor: '#ef4444', // 红色
                    backgroundColor: 'transparent',
                    borderWidth: 1,
                    borderDash: [3, 3],
                    fill: false,
                    tension: 0.3,
                    yAxisID: 'y1'
                }
            ];
            
            // 子图表数据集
            const subDatasets = [
                {
                    type: 'line',
                    label: '反向电能计量比率',
                    data: chartData.exportRatioData,
                    borderColor: '#059669', // 绿色
                    backgroundColor: 'rgba(5, 150, 105, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    yAxisID: 'y',
                    order: 0
                },
                {
                    type: 'bar',
                    label: '电表异常事件数量',
                    data: chartData.eventCountData,
                    backgroundColor: 'rgba(239, 68, 68, 0.6)', // 红色
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1,
                    yAxisID: 'y1',
                    order: 1
                }
            ];
            
            return {
                mainChartTitle: '光伏发电与反向电能计量对比',
                subChartTitle: '反向电能计量准确率分析',
                mainChartType: 'line',
                subChartType: 'line',
                mainChartData: { labels: chartData.labels, datasets: mainDatasets },
                subChartData: { labels: chartData.labels, datasets: subDatasets },
                mainChartOptions: mainChartOptions,
                subChartOptions: subChartOptions
            };
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 渲染标签
            renderTags(currentType);
            
            // 关闭弹窗
            document.getElementById('closeTagModal').addEventListener('click', () => {
                document.getElementById('tagDetailModal').classList.add('hidden');
            });
            
            // 点击弹窗外部关闭弹窗
            document.getElementById('tagDetailModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('tagDetailModal')) {
                    document.getElementById('tagDetailModal').classList.add('hidden');
                }
            });
        });
    </script>
    
    <script>
        // 图表初始化观察器 - 用于监听标签详情加载完成事件并执行额外的图表初始化逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 监听标签详情加载完成事件
            document.addEventListener('tagDetailsLoaded', function(e) {
                // 任何在主系统之外需要执行的标签特定逻辑可以放在这里
                // 目前所有标签类型已经集成到主图表系统中，此处保留扩展点以供未来使用
                
                // 示例：对特定标签类型执行额外的UI更新
                if (e.detail && e.detail.title === '供电半径过长') {
                    // 可以在这里添加额外的UI更新，但图表渲染已经由主系统处理
                    console.log('供电半径过长标签详情已加载');
                }
            });
        });
    </script>
</body>
</html> 